# Unattended macOS Tahoe Setup Assistant Configuration
# Use with: lume create my-vm --os macOS --ipsw latest --unattended tahoe

# Seconds to wait after VM boots before starting automation
boot_wait: 30

boot_commands:
  # Wait for greeting screen to appear (shows "Hello" animation cycling through languages)
  # The boot_wait should be enough for the VM to reach this screen
  # Note: VM framebuffer is 1920x1440 (Retina-scaled)
  - "<delay 5>"

  # Press spacebar to dismiss the greeting screen ("Hello" animation)
  - "<space>"
  - "<delay 2>"

  # Language selection screen
  # Wait for "English" to be visible in the list (may take a moment as languages cycle)
  - "<wait 'English', timeout=120>"
  - "<delay 1>"

  # Type "English" to filter the list, click on "English" to select it, then press Enter
  - "<type 'English'>"
  - "<delay 1>"
  - "<click 'English'>"
  - "<delay 1>"
  - "<enter>"
  - "<delay 2>"

  # Country/Region selection
  - "<wait 'Country or Region'>"
  - "<delay 1>"
  # Click in the center of the list area to give it focus before typing
  - "<click_at 960,900>"
  - "<delay 1>"
  # Type to filter the country list
  - "<type 'United States'>"
  - "<delay 1>"
  # Press Enter to select the filtered item in the list
  - "<enter>"
  - "<delay 1>"
  # Click Continue button to proceed
  - "<click 'Continue'>"
  - "<delay 2>"

  # Transfer Your Data to This Mac (Migration Assistant)
  - "<wait 'Transfer Your Data'>"
  - "<delay 30>" # wait for refresh
  # Use tab navigation to select "Set up as new" (4th option)
  - "<click 'Set up as new'>"
  - "<delay 2>"
  - "<click 'Continue'>"
  - "<delay 2>"

  # Written and Spoken Languages screen (appears AFTER "Set up as new")
  - "<wait 'Written and Spoken Languages'>"
  - "<delay 1>"
  - "<click 'Continue'>"
  - "<delay 2>"

  # Accessibility screen - skip it
  - "<wait 'Accessibility'>"
  - "<delay 1>"
  - "<click 'Not Now'>"
  - "<delay 2>"

  # Data & Privacy screen
  - "<wait 'Data & Privacy'>"
  - "<delay 1>"
  - "<click 'Continue'>"
  - "<delay 2>"

  # Create a Mac Account
  # Field order: Full Name -> Account Name (auto-filled) -> Password -> Verify Password -> Hint -> Checkbox -> Continue
  - "<wait 'Create a Mac Account'>"
  - "<delay 10>"
  - "<click 'Full Name'>"
  - "<delay 1>"
  # Type Full Name
  - "<type 'lume'>"
  - "<delay 1>"
  - "<tab>"
  - "<delay 1>"
  # Skip Account Name (auto-filled from Full Name)
  - "<tab>"
  - "<delay 1>"
  # Type Password
  - "<type 'lume'>"
  - "<delay 1>"
  - "<tab>"
  - "<delay 1>"
  # Type Verify Password
  - "<type 'lume'>"
  - "<delay 1>"
  - "<tab>"
  - "<delay 1>"
  # Skip Hint field
  - "<tab>"
  - "<delay 1>"
  # Untoggle "Allow computer account password to be reset with Apple Account" checkbox
  - "<space>"
  - "<delay 1>"
  # Click Continue button
  - "<click 'Continue'>"
  - "<delay 2>"

  # Sign In to Your Apple Account - skip it
  # Wait for "Email or Phone Number" to appear (indicates page is fully loaded and buttons are clickable)
  - "<wait 'Email or Phone Number'>"
  - "<delay 1>"
  - "<click 'Set Up Later'>"
  - "<delay 1>"
  # Confirmation popup: "Are you sure you want to skip signing in with an Apple Account?"
  # Tab to move focus to "Skip" button, then press Enter
  - '<wait "Don''t Skip">'
  - "<delay 1>"
  - "<tab>"
  - "<delay 1>"
  - "<enter>"
  - "<delay 2>"

  # Terms and Conditions
  # "Agree" appears in license text, so use index=-1 to click the last occurrence (the button)
  - "<wait 'Terms and Conditions'>"
  - "<delay 1>"
  - "<click 'Agree', index=-1>"
  - "<delay 1>"
  # Confirmation popup: "I have read and agree to the macOS Software License Agreement"
  # Modal "Agree" button is above the grayed-out background button, so use index=0 (first/topmost)
  - "<wait 'I have read and agree'>"
  - "<delay 1>"
  - "<click 'Agree', index=0>"
  - "<delay 2>"

  # Enable Location Services (skip it)
  - "<wait 'Enable Location Services'>"
  - "<delay 1>"
  - "<click 'Continue'>"
  - "<delay 1>"
  # Confirmation popup: "Are you sure you don't want to use Location Services?"
  - '<wait "Don''t Use">'
  - "<delay 1>"
  - "<enter>"
  - "<delay 2>"

  # Select Your Time Zone
  - "<wait 'Select Your Time Zone'>"
  - "<delay 1>"
  - "<click 'Continue'>"
  - "<delay 2>"

  # Analytics
  - "<wait 'Analytics'>"
  - "<delay 1>"
  - "<click 'Continue'>"
  - "<delay 2>"

  # Screen Time
  - "<wait 'Screen Time'>"
  - "<delay 1>"
  - "<click 'Set Up Later'>"
  - "<delay 2>"

  # Siri (longer timeout as Screen Time page can be slow)
  - "<wait 'Siri', timeout=300>"
  - "<delay 2>"
  - "<click 'Enable Ask Siri'>"
  - "<delay 2>"
  - "<click 'Continue'>"
  - "<delay 2>"

  # FileVault - skip it
  - "<wait 'FileVault'>"
  - "<delay 1>"
  - "<click 'Not Now'>"
  - "<delay 1>"
  # Confirmation popup: "Mac Data Will Not Be Securely Encrypted"
  - "<wait 'Securely Encrypted'>"
  - "<delay 1>"
  - "<click 'Continue'>"
  - "<delay 2>"

  # Choose Your Look (Light/Dark mode)
  - "<wait 'Choose Your Look'>"
  - "<delay 1>"
  - "<click 'Continue'>"
  - "<delay 2>"

  # Update Mac Automatically
  - "<wait 'Update Mac Automatically'>"
  - "<delay 1>"
  - "<click 'Continue'>"
  - "<delay 2>"

  # Welcome screen - final step
  - "<wait 'welcome'>"
  - "<delay 1>"
  - "<click 'Get Started'>"
  - "<delay 5>"

  # Setup complete - wait for desktop to fully load
  - "<delay 30>"

  # Click on desktop to give it keyboard focus
  # Without this, hotkeys won't work (you'll hear the "trrr" error sound)
  - "<click_at 960,540>"
  - "<delay 1>"

  # Open Spotlight with Cmd+Space
  - "<cmd+space>"
  - "<delay 2>"

  # Type "Terminal" to search for Terminal app
  - "<type 'Terminal'>"
  - "<delay 1>"

  # Press Enter to launch Terminal
  - "<enter>"
  - "<delay 3>"

  # ============================================
  # 1. Enable SSH (Remote Login)
  # ============================================
  # Enable Remote Login (SSH) using launchctl (works without Full Disk Access)
  - "<type 'sudo launchctl load -w /System/Library/LaunchDaemons/ssh.plist'>"
  - "<enter>"
  - "<delay 1>"

  # Enter the password when prompted
  - "<type 'lume'>"
  - "<enter>"
  - "<delay 2>"

  # ============================================
  # 2. Enable Auto-Login (macOS Ventura+)
  # ============================================
  # Use sysadminctl to enable auto-login for the lume user
  - "<type 'sudo sysadminctl -autologin set -userName lume -password lume'>"
  - "<enter>"
  - "<delay 2>"

  # ============================================
  # 3. Disable Screen Lock and Sleep
  # ============================================
  # Disable screen saver
  - "<type 'defaults -currentHost write com.apple.screensaver idleTime -int 0'>"
  - "<enter>"
  - "<delay 1>"

  # Disable require password after sleep/screen saver
  - "<type 'defaults write com.apple.screensaver askForPassword -int 0'>"
  - "<enter>"
  - "<delay 1>"

  # Prevent display from sleeping (never)
  - "<type 'sudo pmset -a displaysleep 0'>"
  - "<enter>"
  - "<delay 1>"

  # Prevent system sleep (never)
  - "<type 'sudo pmset -a sleep 0'>"
  - "<enter>"
  - "<delay 1>"

  # Disable auto-logout
  - "<type 'sudo defaults write /Library/Preferences/.GlobalPreferences com.apple.autologout.AutoLogOutDelay -int 0'>"
  - "<enter>"
  - "<delay 1>"

  # ============================================
  # 4. Enable Full Disk Access for Remote Users
  # ============================================
  # This requires navigating System Settings GUI since TCC.db is SIP-protected

  # Enable full keyboard navigation so Tab works on all UI elements
  - "<type 'defaults write NSGlobalDomain AppleKeyboardUIMode -int 3'>"
  - "<enter>"
  - "<delay 1>"

  # Close Terminal
  - "<cmd+q>"
  - "<delay 2>"

  # Click on desktop to ensure keyboard focus before Spotlight
  - "<click_at 960,540>"
  - "<delay 1>"

  # Open Spotlight and search for System Settings
  - "<cmd+space>"
  - "<delay 2>"
  - "<type 'System Settings'>"
  - "<delay 2>"
  - "<enter>"
  - "<delay 5>"

  # Wait for System Settings to fully load (sidebar shows General)
  - "<wait 'General', timeout=30>"
  - "<delay 2>"

  # Use keyboard shortcut to focus search field (more reliable than clicking)
  - "<cmd+f>"
  - "<delay 1>"
  - "<type 'login'>"
  - "<delay 2>"
  - "<click 'Remote Login'>"
  - "<delay 10>"

  # Tab to reach the "Allow full disk access" toggle, then Space to toggle
  - "<tab>"
  - "<delay 0.5>"
  - "<space>"
  - "<delay 2>"

  # Close System Settings
  - "<cmd+q>"
  - "<delay 1>"

  # ============================================
  # Setup Complete!
  # ============================================
  # SSH is now enabled - Connect with: ssh lume@<ip-address> (password: lume)
  # Auto-login is enabled - VM will boot directly to desktop
  # Full disk access for remote users is enabled via TCC database

# Health check to verify setup was successful
# This will SSH into the VM to confirm SSH is working
health_check:
  type: ssh
  user: lume
  password: lume
  timeout: 30
  retries: 5
  retry_delay: 10
