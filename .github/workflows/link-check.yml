name: Link Checker

on:
  pull_request:
  push:
  workflow_dispatch:

jobs:
  link-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Restore lychee cache
        uses: actions/cache@v4
        with:
          path: .lycheecache
          key: cache-lychee-${{ github.sha }}
          restore-keys: cache-lychee-

      - name: Run Lychee link checker
        uses: lycheeverse/lychee-action@v2
        id: lychee
        with:
          # Check all markdown files
          args: |
            --cache
            --max-cache-age 1d
            --verbose
            --no-progress
            --exclude-mail
            '**/*.md'
          # Output results to file for parsing
          output: lychee-output.md
          # Don't fail the build on broken links (warning mode)
          fail: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Parse link check results
        id: parse-results
        if: always()
        run: |
          # Use lychee exit code: 0 = success, >0 = errors found
          EXIT_CODE="${{ steps.lychee.outputs.exit_code }}"

          # Set status based on exit code
          if [ "$EXIT_CODE" = "0" ]; then
            echo "STATUS_ICON=âœ…" >> $GITHUB_ENV
            echo "STATUS_TEXT=All links are working" >> $GITHUB_ENV
            echo "COLOR=#36a64f" >> $GITHUB_ENV
            echo "BROKEN_COUNT=0" >> $GITHUB_ENV
          else
            echo "STATUS_ICON=âš ï¸" >> $GITHUB_ENV
            echo "STATUS_TEXT=Some links may be broken" >> $GITHUB_ENV
            echo "COLOR=#ffa500" >> $GITHUB_ENV
            echo "BROKEN_COUNT=Check workflow logs" >> $GITHUB_ENV
          fi

      - name: Send results to Slack
        if: always()
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_CHANNEL: ${{ vars.SLACK_CHANNEL }}
          SLACK_TITLE: "ðŸ”— Link Check Results"
          SLACK_COLOR: ${{ env.COLOR }}
          SLACK_MESSAGE: |
            *Status:* ${{ env.STATUS_ICON }} ${{ env.STATUS_TEXT }}

            *Branch:* ${{ github.ref_name }}
            *Commit:* ${{ github.event.head_commit.message || 'See PR description' }}

            *Run Details:* ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
