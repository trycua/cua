<div
  style="
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: row;
    overflow: hidden;
  "
>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family:
        -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      height: 100vh;
      display: flex;
      background: #1a1d21;
      color: #d1d2d3;
    }

    /* Workspace Rail (leftmost narrow bar) */
    .workspace-rail {
      width: 70px;
      background: #3f0e40;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 12px 0;
      gap: 8px;
    }

    .workspace-icon {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      background: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 20px;
      font-weight: bold;
      color: #3f0e40;
      border: 3px solid transparent;
      transition: border-radius 0.2s;
    }

    .workspace-icon:hover {
      border-radius: 16px;
    }

    .workspace-icon.active {
      border: 3px solid #fff;
    }

    .workspace-icon.add-workspace {
      background: transparent;
      border: 2px dashed rgba(255, 255, 255, 0.4);
      color: rgba(255, 255, 255, 0.7);
      font-size: 24px;
      font-weight: 300;
    }

    .workspace-icon.add-workspace:hover {
      border-color: rgba(255, 255, 255, 0.7);
      color: #fff;
    }

    .workspace-rail-spacer {
      flex: 1;
    }

    .user-avatar-container {
      position: relative;
    }

    .user-avatar {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      cursor: pointer;
      overflow: hidden;
    }

    .user-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .user-status-dot {
      position: absolute;
      bottom: -2px;
      right: -2px;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: #2bac76;
      border: 3px solid #3f0e40;
    }

    /* Navigation Sidebar */
    .nav-sidebar {
      width: 70px;
      background: #19171d;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 16px 0;
      border-right: 1px solid #383838;
    }

    .nav-item {
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 12px 0;
      cursor: pointer;
      color: #9a9b9c;
      text-decoration: none;
      gap: 4px;
      transition: color 0.15s;
    }

    .nav-item:hover {
      color: #fff;
    }

    .nav-item.active {
      color: #fff;
    }

    .nav-item.active .nav-icon-wrapper {
      background: rgba(255, 255, 255, 0.1);
    }

    .nav-icon-wrapper {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.15s;
    }

    .nav-item:hover .nav-icon-wrapper {
      background: rgba(255, 255, 255, 0.1);
    }

    .nav-icon {
      font-size: 20px;
    }

    .nav-label {
      font-size: 11px;
      font-weight: 500;
    }

    .nav-spacer {
      flex: 1;
    }

    .nav-add-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.1);
      border: none;
      color: #fff;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-top: auto;
      margin-bottom: 16px;
    }

    .nav-add-btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    /* Channels Sidebar */
    .sidebar {
      width: 260px;
      background: #19171d;
      display: flex;
      flex-direction: column;
      border-right: 1px solid #383838;
    }

    .workspace-header {
      padding: 12px 16px;
      border-bottom: 1px solid #383838;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .workspace-name {
      font-weight: 900;
      font-size: 18px;
      color: #fff;
    }

    .sidebar-section {
      padding: 12px 0;
    }

    .sidebar-section-title {
      padding: 0 16px 8px;
      font-size: 13px;
      color: #9a9b9c;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .channel-list {
      list-style: none;
    }

    .channel-item {
      padding: 6px 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 15px;
    }

    .channel-item:hover {
      background: #27242c;
    }

    .channel-item.active {
      background: #1264a3;
      color: #fff;
    }

    .channel-item .hash {
      color: #9a9b9c;
      font-size: 16px;
    }

    .channel-item.active .hash {
      color: #fff;
    }

    /* Main content */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #1a1d21;
    }

    .channel-header {
      padding: 12px 20px;
      border-bottom: 1px solid #383838;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .channel-header-name {
      font-weight: 900;
      font-size: 18px;
      color: #fff;
    }

    .channel-header-info {
      font-size: 13px;
      color: #9a9b9c;
    }

    /* Messages area */
    .messages-container {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }

    .message {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
      padding: 8px;
      border-radius: 6px;
      position: relative;
    }

    .message:hover {
      background: #222529;
    }

    .message-avatar {
      width: 36px;
      height: 36px;
      border-radius: 4px;
      background: #4a154b;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-weight: bold;
      font-size: 14px;
      flex-shrink: 0;
    }

    .message-content {
      flex: 1;
    }

    .message-header {
      display: flex;
      align-items: baseline;
      gap: 8px;
      margin-bottom: 4px;
    }

    .message-author {
      font-weight: 900;
      color: #fff;
    }

    .message-time {
      font-size: 12px;
      color: #9a9b9c;
    }

    .message-text {
      line-height: 1.46;
      word-wrap: break-word;
    }

    /* Message actions (reply button) */
    .message-actions {
      position: absolute;
      top: -12px;
      right: 8px;
      background: #1a1d21;
      border: 1px solid #383838;
      border-radius: 6px;
      display: none;
      padding: 4px;
    }

    .message:hover .message-actions {
      display: flex;
      gap: 2px;
    }

    .message-action-btn {
      width: 28px;
      height: 28px;
      border: none;
      background: transparent;
      color: #9a9b9c;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }

    .message-action-btn:hover {
      background: #383838;
      color: #fff;
    }

    /* Message reactions */
    .message-reactions {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 6px;
    }

    .reaction-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      background: #222529;
      border: 1px solid #383838;
      border-radius: 12px;
      font-size: 12px;
      cursor: pointer;
      transition:
        background 0.15s,
        border-color 0.15s;
    }

    .reaction-badge:hover {
      background: #2a2d31;
      border-color: #565856;
    }

    .reaction-badge.user-reacted {
      background: rgba(29, 155, 209, 0.2);
      border-color: #1d9bd1;
    }

    .reaction-badge .reaction-emoji {
      font-size: 14px;
    }

    .reaction-badge .reaction-count {
      color: #d1d2d3;
      font-weight: 500;
    }

    .add-reaction-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 26px;
      height: 26px;
      background: transparent;
      border: 1px dashed #383838;
      border-radius: 12px;
      font-size: 12px;
      cursor: pointer;
      color: #9a9b9c;
      transition:
        background 0.15s,
        border-color 0.15s;
    }

    .add-reaction-btn:hover {
      background: #222529;
      border-color: #565856;
      color: #fff;
    }

    /* Emoji picker */
    .emoji-picker {
      position: absolute;
      top: 100%;
      right: 0;
      background: #1a1d21;
      border: 1px solid #383838;
      border-radius: 8px;
      padding: 8px;
      display: none;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .emoji-picker.open {
      display: block;
    }

    .emoji-picker-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 4px;
    }

    .emoji-picker-btn {
      width: 32px;
      height: 32px;
      border: none;
      background: transparent;
      border-radius: 4px;
      font-size: 18px;
      cursor: pointer;
      transition: background 0.15s;
    }

    .emoji-picker-btn:hover {
      background: #383838;
    }

    /* Thread indicator */
    .thread-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
      padding: 4px 8px;
      background: transparent;
      border: none;
      color: #1d9bd1;
      font-size: 13px;
      cursor: pointer;
      border-radius: 4px;
    }

    .thread-indicator:hover {
      background: #222529;
      text-decoration: underline;
    }

    .thread-avatars {
      display: flex;
    }

    .thread-avatar {
      width: 20px;
      height: 20px;
      border-radius: 4px;
      margin-left: -4px;
      border: 2px solid #1a1d21;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 8px;
      font-weight: bold;
    }

    .thread-avatar:first-child {
      margin-left: 0;
    }

    /* Thread panel */
    .thread-panel {
      width: 400px;
      background: #1a1d21;
      border-left: 1px solid #383838;
      display: none;
      flex-direction: column;
    }

    .thread-panel.open {
      display: flex;
    }

    .thread-header {
      padding: 12px 16px;
      border-bottom: 1px solid #383838;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .thread-header-title {
      font-weight: 900;
      font-size: 16px;
      color: #fff;
    }

    .thread-header-channel {
      font-size: 13px;
      color: #9a9b9c;
    }

    .thread-close-btn {
      width: 28px;
      height: 28px;
      border: none;
      background: transparent;
      color: #9a9b9c;
      border-radius: 4px;
      cursor: pointer;
      font-size: 18px;
    }

    .thread-close-btn:hover {
      background: #383838;
      color: #fff;
    }

    .thread-messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }

    .thread-parent-message {
      padding-bottom: 16px;
      border-bottom: 1px solid #383838;
      margin-bottom: 16px;
    }

    .thread-replies-label {
      font-size: 13px;
      color: #9a9b9c;
      margin-bottom: 12px;
    }

    .thread-input-container {
      padding: 0 16px 16px;
    }

    .thread-input-wrapper {
      background: #222529;
      border: 1px solid #565856;
      border-radius: 8px;
      overflow: hidden;
    }

    .thread-input {
      width: 100%;
      padding: 10px 12px;
      background: transparent;
      border: none;
      color: #d1d2d3;
      font-size: 14px;
      outline: none;
      resize: none;
      font-family: inherit;
    }

    .thread-input::placeholder {
      color: #9a9b9c;
    }

    .thread-input-toolbar {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding: 6px 8px;
      border-top: 1px solid #383838;
    }

    .thread-send-btn {
      background: #007a5a;
      color: #fff;
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 700;
      font-size: 12px;
    }

    .thread-send-btn:hover {
      background: #148567;
    }

    .thread-send-btn:disabled {
      background: #383838;
      color: #9a9b9c;
      cursor: not-allowed;
    }

    /* Message input */
    .message-input-container {
      padding: 0 20px 20px;
    }

    .message-input-wrapper {
      background: #222529;
      border: 1px solid #565856;
      border-radius: 8px;
      overflow: hidden;
    }

    .message-input {
      width: 100%;
      padding: 12px 16px;
      background: transparent;
      border: none;
      color: #d1d2d3;
      font-size: 15px;
      outline: none;
      resize: none;
      font-family: inherit;
    }

    .message-input::placeholder {
      color: #9a9b9c;
    }

    .message-input-toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 12px;
      border-top: 1px solid #383838;
    }

    .toolbar-buttons {
      display: flex;
      gap: 4px;
    }

    .toolbar-btn {
      width: 28px;
      height: 28px;
      border: none;
      background: transparent;
      color: #9a9b9c;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
    }

    .toolbar-btn:hover {
      background: #383838;
      color: #fff;
    }

    .send-btn {
      background: #007a5a;
      color: #fff;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 700;
      font-size: 13px;
    }

    .send-btn:hover {
      background: #148567;
    }

    .send-btn:disabled {
      background: #383838;
      color: #9a9b9c;
      cursor: not-allowed;
    }

    /* User presence indicator */
    .user-status {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #2bac76;
      border: 2px solid #19171d;
    }

    .dm-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .dm-avatar {
      width: 20px;
      height: 20px;
      border-radius: 4px;
      background: #e01e5a;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 10px;
      font-weight: bold;
    }

    /* SVG Icons */
    .nav-icon svg {
      width: 20px;
      height: 20px;
      fill: currentColor;
    }

    /* Nav View Panels */
    .nav-view {
      display: none;
      flex-direction: column;
      height: 100%;
    }

    .nav-view.active {
      display: flex;
    }

    .nav-view-header {
      padding: 16px 20px;
      border-bottom: 1px solid #383838;
    }

    .nav-view-title {
      font-weight: 900;
      font-size: 18px;
      color: #fff;
      margin-bottom: 4px;
    }

    .nav-view-subtitle {
      font-size: 13px;
      color: #9a9b9c;
    }

    .nav-view-content {
      flex: 1;
      overflow-y: auto;
      padding: 16px 20px;
    }

    /* Activity items */
    .activity-item {
      display: flex;
      gap: 12px;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 8px;
      cursor: pointer;
    }

    .activity-item:hover {
      background: #222529;
    }

    .activity-icon {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .activity-icon.mention {
      background: #1264a3;
      color: #fff;
    }

    .activity-icon.reaction {
      background: #ecb22e;
    }

    .activity-icon.thread {
      background: #2eb67d;
      color: #fff;
    }

    .activity-content {
      flex: 1;
      min-width: 0;
    }

    .activity-title {
      font-weight: 600;
      color: #fff;
      margin-bottom: 4px;
    }

    .activity-preview {
      font-size: 13px;
      color: #9a9b9c;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .activity-time {
      font-size: 12px;
      color: #9a9b9c;
      flex-shrink: 0;
    }

    /* File items */
    .file-item {
      display: flex;
      gap: 12px;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 8px;
      cursor: pointer;
      border: 1px solid #383838;
    }

    .file-item:hover {
      background: #222529;
    }

    .file-icon {
      width: 40px;
      height: 40px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      flex-shrink: 0;
    }

    .file-icon.doc {
      background: #1264a3;
    }
    .file-icon.image {
      background: #2eb67d;
    }
    .file-icon.pdf {
      background: #e01e5a;
    }
    .file-icon.code {
      background: #ecb22e;
    }

    .file-info {
      flex: 1;
      min-width: 0;
    }

    .file-name {
      font-weight: 600;
      color: #fff;
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .file-meta {
      font-size: 12px;
      color: #9a9b9c;
    }

    /* Saved items */
    .saved-item {
      display: flex;
      gap: 12px;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 8px;
      cursor: pointer;
      border-left: 3px solid #ecb22e;
      background: #222529;
    }

    .saved-item:hover {
      background: #2a2d31;
    }

    .saved-content {
      flex: 1;
    }

    .saved-channel {
      font-size: 12px;
      color: #1d9bd1;
      margin-bottom: 4px;
    }

    .saved-text {
      color: #d1d2d3;
      margin-bottom: 4px;
    }

    .saved-author {
      font-size: 12px;
      color: #9a9b9c;
    }

    /* DM list for DMs view */
    .dm-list-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 4px;
      cursor: pointer;
    }

    .dm-list-item:hover {
      background: #222529;
    }

    .dm-list-avatar {
      width: 36px;
      height: 36px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-weight: bold;
      font-size: 14px;
      flex-shrink: 0;
    }

    .dm-list-info {
      flex: 1;
      min-width: 0;
    }

    .dm-list-name {
      font-weight: 600;
      color: #fff;
    }

    .dm-list-status {
      font-size: 12px;
      color: #9a9b9c;
    }

    .dm-list-status.online::before {
      content: '';
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #2bac76;
      margin-right: 6px;
    }

    .dm-list-status.away::before {
      content: '';
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #ecb22e;
      margin-right: 6px;
    }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #9a9b9c;
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .empty-state-title {
      font-size: 18px;
      font-weight: 600;
      color: #fff;
      margin-bottom: 8px;
    }

    /* Search box */
    .search-box {
      padding: 8px 12px;
      background: #222529;
      border: 1px solid #383838;
      border-radius: 6px;
      color: #d1d2d3;
      font-size: 14px;
      width: 100%;
      margin-bottom: 16px;
    }

    .search-box::placeholder {
      color: #9a9b9c;
    }

    .search-box:focus {
      outline: none;
      border-color: #1264a3;
    }
  </style>
  <!-- Workspace Rail -->
  <div class="workspace-rail">
    <div class="workspace-icon active" title="CUA Workspace">
      <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
        <path
          d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"
        />
      </svg>
    </div>
    <div class="workspace-icon" title="Another Workspace" style="background: #e01e5a; color: #fff">
      <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
        <path
          d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"
        />
      </svg>
    </div>
    <div class="workspace-icon add-workspace" title="Add a workspace">+</div>
    <div class="workspace-rail-spacer"></div>
    <div class="user-avatar-container">
      <div class="user-avatar" title="You">
        <svg viewBox="0 0 24 24" width="36" height="36" fill="#fff">
          <path
            d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"
          />
        </svg>
      </div>
      <div class="user-status-dot"></div>
    </div>
  </div>

  <!-- Navigation Sidebar -->
  <div class="nav-sidebar">
    <a href="#" class="nav-item active" data-nav="home">
      <div class="nav-icon-wrapper">
        <span class="nav-icon">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z" />
          </svg>
        </span>
      </div>
      <span class="nav-label">Home</span>
    </a>
    <a href="#" class="nav-item" data-nav="dms">
      <div class="nav-icon-wrapper">
        <span class="nav-icon">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path
              d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"
            />
          </svg>
        </span>
      </div>
      <span class="nav-label">DMs</span>
    </a>
    <a href="#" class="nav-item" data-nav="activity">
      <div class="nav-icon-wrapper">
        <span class="nav-icon">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path
              d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.64 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2zm-2 1H8v-6c0-2.48 1.51-4.5 4-4.5s4 2.02 4 4.5v6z"
            />
          </svg>
        </span>
      </div>
      <span class="nav-label">Activity</span>
    </a>
    <a href="#" class="nav-item" data-nav="files">
      <div class="nav-icon-wrapper">
        <span class="nav-icon">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path
              d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"
            />
          </svg>
        </span>
      </div>
      <span class="nav-label">Files</span>
    </a>
    <a href="#" class="nav-item" data-nav="later">
      <div class="nav-icon-wrapper">
        <span class="nav-icon">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M17 3H7c-1.1 0-2 .9-2 2v16l7-3 7 3V5c0-1.1-.9-2-2-2z" />
          </svg>
        </span>
      </div>
      <span class="nav-label">Later</span>
    </a>
    <a href="#" class="nav-item" data-nav="more">
      <div class="nav-icon-wrapper">
        <span class="nav-icon">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path
              d="M6 10c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm12 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm-6 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"
            />
          </svg>
        </span>
      </div>
      <span class="nav-label">More</span>
    </a>
    <div class="nav-spacer"></div>
    <button class="nav-add-btn" title="Create new">+</button>
  </div>

  <!-- Channels Sidebar -->
  <div class="sidebar" id="channels-sidebar">
    <div class="workspace-header">
      <span class="workspace-name">CUA Workspace</span>
    </div>

    <div class="sidebar-section">
      <div class="sidebar-section-title">Channels</div>
      <ul class="channel-list" id="channel-list">
        <li class="channel-item active" data-channel="general">
          <span class="hash">#</span>
          <span>general</span>
        </li>
        <li class="channel-item" data-channel="random">
          <span class="hash">#</span>
          <span>random</span>
        </li>
        <li class="channel-item" data-channel="engineering">
          <span class="hash">#</span>
          <span>engineering</span>
        </li>
      </ul>
    </div>

    <div class="sidebar-section">
      <div class="sidebar-section-title">Direct Messages</div>
      <ul class="channel-list">
        <li class="channel-item" data-channel="dm-alice">
          <div class="dm-item">
            <div class="dm-avatar">A</div>
            <span>Alice Chen</span>
          </div>
        </li>
        <li class="channel-item" data-channel="dm-bob">
          <div class="dm-item">
            <div class="dm-avatar" style="background: #36c5f0">B</div>
            <span>Bob Smith</span>
          </div>
        </li>
      </ul>
    </div>
  </div>

  <div class="main-content">
    <!-- Home View (Channel Messages) -->
    <div class="nav-view active" id="view-home">
      <div class="channel-header">
        <span class="hash" style="color: #9a9b9c; font-size: 20px">#</span>
        <span class="channel-header-name" id="current-channel-name">general</span>
        <span class="channel-header-info">| Team discussions and announcements</span>
      </div>

      <div class="messages-container" id="messages-container"></div>

      <div class="message-input-container">
        <div class="message-input-wrapper">
          <textarea
            class="message-input"
            id="message-input"
            placeholder="Message #general"
            rows="1"
          ></textarea>
          <div class="message-input-toolbar">
            <div class="toolbar-buttons">
              <button class="toolbar-btn" title="Add emoji">+</button>
              <button class="toolbar-btn" title="Mention">@</button>
              <button class="toolbar-btn" title="Attach file">üìé</button>
            </div>
            <button class="send-btn" id="send-btn" disabled>Send</button>
          </div>
        </div>
      </div>
    </div>

    <!-- DMs View -->
    <div class="nav-view" id="view-dms">
      <div class="nav-view-header">
        <div class="nav-view-title">Direct Messages</div>
        <div class="nav-view-subtitle">All your conversations in one place</div>
      </div>
      <div class="nav-view-content">
        <input type="text" class="search-box" placeholder="Search direct messages..." />

        <div class="dm-list-item" data-dm-channel="dm-alice">
          <div class="dm-list-avatar" style="background: #4a154b">AC</div>
          <div class="dm-list-info">
            <div class="dm-list-name">Alice Chen</div>
            <div class="dm-list-status online">Active</div>
          </div>
        </div>

        <div class="dm-list-item" data-dm-channel="dm-bob">
          <div class="dm-list-avatar" style="background: #36c5f0">BS</div>
          <div class="dm-list-info">
            <div class="dm-list-name">Bob Smith</div>
            <div class="dm-list-status online">Active</div>
          </div>
        </div>

        <div class="dm-list-item">
          <div class="dm-list-avatar" style="background: #e01e5a">CJ</div>
          <div class="dm-list-info">
            <div class="dm-list-name">Carol Johnson</div>
            <div class="dm-list-status away">Away</div>
          </div>
        </div>

        <div class="dm-list-item">
          <div class="dm-list-avatar" style="background: #2eb67d">DW</div>
          <div class="dm-list-info">
            <div class="dm-list-name">Dave Wilson</div>
            <div class="dm-list-status online">Active</div>
          </div>
        </div>

        <div class="dm-list-item">
          <div class="dm-list-avatar" style="background: #ecb22e">EM</div>
          <div class="dm-list-info">
            <div class="dm-list-name">Eve Martinez</div>
            <div class="dm-list-status away">Away</div>
          </div>
        </div>

        <div class="dm-list-item">
          <div class="dm-list-avatar" style="background: #4a154b">FL</div>
          <div class="dm-list-info">
            <div class="dm-list-name">Frank Lee</div>
            <div class="dm-list-status online">Active</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Activity View -->
    <div class="nav-view" id="view-activity">
      <div class="nav-view-header">
        <div class="nav-view-title">Activity</div>
        <div class="nav-view-subtitle">Mentions, reactions, and replies</div>
      </div>
      <div class="nav-view-content">
        <div class="activity-item">
          <div class="activity-icon mention">@</div>
          <div class="activity-content">
            <div class="activity-title">Carol Johnson mentioned you</div>
            <div class="activity-preview">@you can you review the PR when you get a chance?</div>
          </div>
          <div class="activity-time">10:45 AM</div>
        </div>

        <div class="activity-item">
          <div class="activity-icon reaction">üëç</div>
          <div class="activity-content">
            <div class="activity-title">Bob Smith reacted to your message</div>
            <div class="activity-preview">"Try adding an index on orders.created_at..."</div>
          </div>
          <div class="activity-time">11:30 AM</div>
        </div>

        <div class="activity-item">
          <div class="activity-icon thread">üí¨</div>
          <div class="activity-content">
            <div class="activity-title">New reply in thread</div>
            <div class="activity-preview">Alice Chen: "Thanks for the update!"</div>
          </div>
          <div class="activity-time">9:15 AM</div>
        </div>

        <div class="activity-item">
          <div class="activity-icon mention">@</div>
          <div class="activity-content">
            <div class="activity-title">Dave Wilson mentioned you in #engineering</div>
            <div class="activity-preview">@you thoughts on the new architecture?</div>
          </div>
          <div class="activity-time">Yesterday</div>
        </div>

        <div class="activity-item">
          <div class="activity-icon reaction">üéâ</div>
          <div class="activity-content">
            <div class="activity-title">3 people reacted to your message</div>
            <div class="activity-preview">"The deployment was successful!"</div>
          </div>
          <div class="activity-time">Yesterday</div>
        </div>

        <div class="activity-item">
          <div class="activity-icon thread">üí¨</div>
          <div class="activity-content">
            <div class="activity-title">New reply in thread</div>
            <div class="activity-preview">Frank Lee: "I'll take a look at the docs"</div>
          </div>
          <div class="activity-time">Monday</div>
        </div>
      </div>
    </div>

    <!-- Files View -->
    <div class="nav-view" id="view-files">
      <div class="nav-view-header">
        <div class="nav-view-title">Files</div>
        <div class="nav-view-subtitle">All files shared in your workspace</div>
      </div>
      <div class="nav-view-content">
        <input type="text" class="search-box" placeholder="Search files..." />

        <div class="file-item">
          <div class="file-icon doc">üìÑ</div>
          <div class="file-info">
            <div class="file-name">Q4 Planning Document.docx</div>
            <div class="file-meta">Shared by Alice Chen in #general - Today</div>
          </div>
        </div>

        <div class="file-item">
          <div class="file-icon image">üñºÔ∏è</div>
          <div class="file-info">
            <div class="file-name">dashboard-mockup.png</div>
            <div class="file-meta">Shared by Carol Johnson in #engineering - Today</div>
          </div>
        </div>

        <div class="file-item">
          <div class="file-icon pdf">üìï</div>
          <div class="file-info">
            <div class="file-name">API Documentation v2.pdf</div>
            <div class="file-meta">Shared by Frank Lee in #engineering - Yesterday</div>
          </div>
        </div>

        <div class="file-item">
          <div class="file-icon code">üíª</div>
          <div class="file-info">
            <div class="file-name">deploy-script.sh</div>
            <div class="file-meta">Shared by Dave Wilson in #engineering - Yesterday</div>
          </div>
        </div>

        <div class="file-item">
          <div class="file-icon image">üñºÔ∏è</div>
          <div class="file-info">
            <div class="file-name">team-photo.jpg</div>
            <div class="file-meta">Shared by Eve Martinez in #random - Monday</div>
          </div>
        </div>

        <div class="file-item">
          <div class="file-icon doc">üìÑ</div>
          <div class="file-info">
            <div class="file-name">Meeting Notes - Sprint Review.docx</div>
            <div class="file-meta">Shared by Bob Smith in #general - Monday</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Later (Saved) View -->
    <div class="nav-view" id="view-later">
      <div class="nav-view-header">
        <div class="nav-view-title">Later</div>
        <div class="nav-view-subtitle">Messages and files you've saved for later</div>
      </div>
      <div class="nav-view-content">
        <div class="saved-item">
          <div class="saved-content">
            <div class="saved-channel">#engineering</div>
            <div class="saved-text">
              The new deployment scripts are ready for review:
              https://github.com/cua/scripts/pull/42
            </div>
            <div class="saved-author">Alice Chen - 8:30 AM</div>
          </div>
        </div>

        <div class="saved-item">
          <div class="saved-content">
            <div class="saved-channel">#general</div>
            <div class="saved-text">
              Reminder: Team sync at 2pm today. Please review the agenda beforehand.
            </div>
            <div class="saved-author">Carol Johnson - Yesterday</div>
          </div>
        </div>

        <div class="saved-item">
          <div class="saved-content">
            <div class="saved-channel">DM with Bob Smith</div>
            <div class="saved-text">
              SELECT * FROM users u JOIN orders o ON u.id = o.user_id WHERE o.created_at > NOW() -
              INTERVAL 30 DAY
            </div>
            <div class="saved-author">Bob Smith - Monday</div>
          </div>
        </div>

        <div class="saved-item">
          <div class="saved-content">
            <div class="saved-channel">#random</div>
            <div class="saved-text">
              Speaking of sports, anyone up for a virtual trivia night this Friday?
            </div>
            <div class="saved-author">Eve Martinez - 9:45 AM</div>
          </div>
        </div>
      </div>
    </div>

    <!-- More View -->
    <div class="nav-view" id="view-more">
      <div class="nav-view-header">
        <div class="nav-view-title">More</div>
        <div class="nav-view-subtitle">Additional features and settings</div>
      </div>
      <div class="nav-view-content">
        <div class="dm-list-item">
          <div class="activity-icon" style="background: #4a154b; color: #fff">üìÅ</div>
          <div class="dm-list-info">
            <div class="dm-list-name">All Channels</div>
            <div class="dm-list-status">Browse and join channels</div>
          </div>
        </div>

        <div class="dm-list-item">
          <div class="activity-icon" style="background: #1264a3; color: #fff">üë•</div>
          <div class="dm-list-info">
            <div class="dm-list-name">People</div>
            <div class="dm-list-status">View workspace members</div>
          </div>
        </div>

        <div class="dm-list-item">
          <div class="activity-icon" style="background: #2eb67d; color: #fff">üîó</div>
          <div class="dm-list-info">
            <div class="dm-list-name">Apps</div>
            <div class="dm-list-status">Manage connected apps</div>
          </div>
        </div>

        <div class="dm-list-item">
          <div class="activity-icon" style="background: #ecb22e; color: #fff">‚ö°</div>
          <div class="dm-list-info">
            <div class="dm-list-name">Workflows</div>
            <div class="dm-list-status">Automate your work</div>
          </div>
        </div>

        <div class="dm-list-item">
          <div class="activity-icon" style="background: #e01e5a; color: #fff">üìä</div>
          <div class="dm-list-info">
            <div class="dm-list-name">Analytics</div>
            <div class="dm-list-status">Workspace insights</div>
          </div>
        </div>

        <div class="dm-list-item">
          <div class="activity-icon" style="background: #383838; color: #fff">‚öôÔ∏è</div>
          <div class="dm-list-info">
            <div class="dm-list-name">Settings</div>
            <div class="dm-list-status">Customize your experience</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Thread Panel -->
  <div class="thread-panel" id="thread-panel">
    <div class="thread-header">
      <div>
        <div class="thread-header-title">Thread</div>
        <div class="thread-header-channel" id="thread-channel-name">#general</div>
      </div>
      <button class="thread-close-btn" id="thread-close-btn">√ó</button>
    </div>
    <div class="thread-messages" id="thread-messages">
      <!-- Parent message will be inserted here -->
      <div class="thread-parent-message" id="thread-parent"></div>
      <div class="thread-replies-label" id="thread-replies-label">0 replies</div>
      <div id="thread-replies"></div>
    </div>
    <div class="thread-input-container">
      <div class="thread-input-wrapper">
        <textarea class="thread-input" id="thread-input" placeholder="Reply..." rows="1"></textarea>
        <div class="thread-input-toolbar">
          <button class="thread-send-btn" id="thread-send-btn" disabled>Reply</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Channel/DM message data
    const channelData = {
      general: {
        description: 'Team discussions and announcements',
        messages: [
          {
            id: 'msg-1',
            author: 'Alice Chen',
            initials: 'AC',
            color: '#4a154b',
            time: '10:30 AM',
            text: 'Good morning everyone! Ready for the standup?',
          },
          {
            id: 'msg-2',
            author: 'Bob Smith',
            initials: 'BS',
            color: '#36c5f0',
            time: '10:32 AM',
            text: 'Morning! Yes, just finishing up my coffee.',
          },
          {
            id: 'msg-3',
            author: 'Carol Johnson',
            initials: 'CJ',
            color: '#e01e5a',
            time: '10:35 AM',
            text: 'I pushed the new feature to staging. Can someone review the PR?',
          },
        ],
      },
      random: {
        description: 'Non-work banter and water cooler chat',
        messages: [
          {
            id: 'msg-r1',
            author: 'Bob Smith',
            initials: 'BS',
            color: '#36c5f0',
            time: '9:15 AM',
            text: 'Anyone catch the game last night?',
          },
          {
            id: 'msg-r2',
            author: 'Dave Wilson',
            initials: 'DW',
            color: '#2eb67d',
            time: '9:18 AM',
            text: 'Yes! What a finish! üèÄ',
          },
          {
            id: 'msg-r3',
            author: 'Alice Chen',
            initials: 'AC',
            color: '#4a154b',
            time: '9:22 AM',
            text: 'I missed it but saw the highlights. Incredible!',
          },
          {
            id: 'msg-r4',
            author: 'Eve Martinez',
            initials: 'EM',
            color: '#ecb22e',
            time: '9:45 AM',
            text: 'Speaking of sports, anyone up for a virtual trivia night this Friday?',
          },
        ],
      },
      engineering: {
        description: 'Engineering team discussions',
        messages: [
          {
            id: 'msg-e1',
            author: 'Carol Johnson',
            initials: 'CJ',
            color: '#e01e5a',
            time: '8:00 AM',
            text: "Reminder: We're migrating to the new CI pipeline today",
          },
          {
            id: 'msg-e2',
            author: 'Frank Lee',
            initials: 'FL',
            color: '#4a154b',
            time: '8:05 AM',
            text: "I've updated the documentation for the API changes",
          },
          {
            id: 'msg-e3',
            author: 'Alice Chen',
            initials: 'AC',
            color: '#4a154b',
            time: '8:30 AM',
            text: 'The new deployment scripts are ready for review: https://github.com/cua/scripts/pull/42',
          },
          {
            id: 'msg-e4',
            author: 'Dave Wilson',
            initials: 'DW',
            color: '#2eb67d',
            time: '9:00 AM',
            text: 'Found a bug in the auth module. Creating a ticket now.',
          },
          {
            id: 'msg-e5',
            author: 'Carol Johnson',
            initials: 'CJ',
            color: '#e01e5a',
            time: '9:15 AM',
            text: '@Dave can you share the error logs?',
          },
        ],
      },
      'dm-alice': {
        description: null,
        isDM: true,
        dmName: 'Alice Chen',
        messages: [
          {
            id: 'msg-da1',
            author: 'Alice Chen',
            initials: 'AC',
            color: '#4a154b',
            time: 'Yesterday',
            text: 'Hey! Do you have a minute to chat about the project timeline?',
          },
          {
            id: 'msg-da2',
            author: 'You',
            initials: 'Y',
            color: '#2bac76',
            time: 'Yesterday',
            text: "Sure, what's up?",
          },
          {
            id: 'msg-da3',
            author: 'Alice Chen',
            initials: 'AC',
            color: '#4a154b',
            time: 'Yesterday',
            text: 'I think we might need to push the deadline by a week. The integration is taking longer than expected.',
          },
          {
            id: 'msg-da4',
            author: 'You',
            initials: 'Y',
            color: '#2bac76',
            time: 'Yesterday',
            text: "That makes sense. Let's discuss it in tomorrow's standup.",
          },
          {
            id: 'msg-da5',
            author: 'Alice Chen',
            initials: 'AC',
            color: '#4a154b',
            time: '10:00 AM',
            text: 'Thanks for understanding! See you at standup üëç',
          },
        ],
      },
      'dm-bob': {
        description: null,
        isDM: true,
        dmName: 'Bob Smith',
        messages: [
          {
            id: 'msg-db1',
            author: 'Bob Smith',
            initials: 'BS',
            color: '#36c5f0',
            time: 'Monday',
            text: 'Hey, can you help me with the database query?',
          },
          {
            id: 'msg-db2',
            author: 'You',
            initials: 'Y',
            color: '#2bac76',
            time: 'Monday',
            text: 'Of course! What do you need?',
          },
          {
            id: 'msg-db3',
            author: 'Bob Smith',
            initials: 'BS',
            color: '#36c5f0',
            time: 'Monday',
            text: "I'm trying to optimize this join but it's running slow",
          },
          {
            id: 'msg-db4',
            author: 'You',
            initials: 'Y',
            color: '#2bac76',
            time: 'Monday',
            text: 'Let me take a look. Can you share the query?',
          },
          {
            id: 'msg-db5',
            author: 'Bob Smith',
            initials: 'BS',
            color: '#36c5f0',
            time: 'Monday',
            text: 'SELECT * FROM users u JOIN orders o ON u.id = o.user_id WHERE o.created_at > NOW() - INTERVAL 30 DAY',
          },
          {
            id: 'msg-db6',
            author: 'You',
            initials: 'Y',
            color: '#2bac76',
            time: 'Monday',
            text: 'Try adding an index on orders.created_at and use EXPLAIN to see the query plan',
          },
          {
            id: 'msg-db7',
            author: 'Bob Smith',
            initials: 'BS',
            color: '#36c5f0',
            time: '11:30 AM',
            text: 'That worked! Query time went from 5s to 200ms. Thanks! üéâ',
          },
        ],
      },
    };

    // Global Slack Shell API for state extraction
    window.__slack_shell = {
      _outboundMessages: [],
      _channelMessages: JSON.parse(JSON.stringify(channelData)), // Deep copy
      _threads: {}, // messageId -> { parentMessage, replies: [] }
      _threadReplies: [], // All thread replies sent by user
      _reactions: {}, // messageId -> { emoji: { count, users: [], userReacted: bool } }
      _userReactions: [], // All reactions added by user: { messageId, emoji, timestamp }
      _currentChannel: 'general',
      _currentThreadId: null,
      _currentNav: 'home',
      _messageIdCounter: 100, // Start high to avoid conflicts

      // Get all outbound messages (messages sent by the user in any channel)
      getOutboundMessages: function () {
        return this._outboundMessages.slice();
      },

      // Get all messages in current channel
      getAllMessages: function () {
        const channel = this._channelMessages[this._currentChannel];
        return channel ? channel.messages.slice() : [];
      },

      // Get messages for a specific channel
      getChannelMessages: function (channelId) {
        const channel = this._channelMessages[channelId];
        return channel ? channel.messages.slice() : [];
      },

      // Get current channel
      getCurrentChannel: function () {
        return this._currentChannel;
      },

      // Get all threads
      getThreads: function () {
        return JSON.parse(JSON.stringify(this._threads));
      },

      // Get thread by message ID
      getThread: function (messageId) {
        return this._threads[messageId]
          ? JSON.parse(JSON.stringify(this._threads[messageId]))
          : null;
      },

      // Get all thread replies sent by user
      getThreadReplies: function () {
        return this._threadReplies.slice();
      },

      // Get current open thread ID
      getCurrentThreadId: function () {
        return this._currentThreadId;
      },

      // Get current navigation item
      getCurrentNav: function () {
        return this._currentNav;
      },

      // Get all reactions for a message
      getReactions: function (messageId) {
        return this._reactions[messageId]
          ? JSON.parse(JSON.stringify(this._reactions[messageId]))
          : {};
      },

      // Get all reactions added by user
      getUserReactions: function () {
        return this._userReactions.slice();
      },

      // Check if user has reacted with specific emoji to a message
      hasUserReacted: function (messageId, emoji) {
        const reactions = this._reactions[messageId];
        if (!reactions || !reactions[emoji]) return false;
        return reactions[emoji].userReacted;
      },

      // Internal: add/toggle reaction to a message
      _addReaction: function (messageId, emoji) {
        if (!this._reactions[messageId]) {
          this._reactions[messageId] = {};
        }

        const reactions = this._reactions[messageId];

        if (!reactions[emoji]) {
          reactions[emoji] = { count: 0, users: [], userReacted: false };
        }

        if (reactions[emoji].userReacted) {
          // Remove user's reaction
          reactions[emoji].count--;
          reactions[emoji].userReacted = false;
          reactions[emoji].users = reactions[emoji].users.filter((u) => u !== 'You');

          // Remove from user reactions list
          this._userReactions = this._userReactions.filter(
            (r) => !(r.messageId === messageId && r.emoji === emoji)
          );

          // Remove emoji entry if count is 0
          if (reactions[emoji].count <= 0) {
            delete reactions[messageId];
          }

          return { added: false, count: reactions[emoji] ? reactions[emoji].count : 0 };
        } else {
          // Add user's reaction
          reactions[emoji].count++;
          reactions[emoji].userReacted = true;
          reactions[emoji].users.push('You');

          // Add to user reactions list
          this._userReactions.push({
            messageId: messageId,
            emoji: emoji,
            timestamp: new Date().toISOString(),
            channel: this._currentChannel,
          });

          return { added: true, count: reactions[emoji].count };
        }
      },

      // Internal: add outbound message to current channel
      _addOutboundMessage: function (text) {
        const msg = {
          id: 'msg-' + ++this._messageIdCounter,
          text: text,
          timestamp: new Date().toISOString(),
          channel: this._currentChannel,
          author: 'You',
          initials: 'Y',
          color: '#2bac76',
          time: new Date().toLocaleTimeString('en-US', {
            hour: 'numeric',
            minute: '2-digit',
            hour12: true,
          }),
        };
        this._outboundMessages.push(msg);
        // Also add to channel messages
        if (this._channelMessages[this._currentChannel]) {
          this._channelMessages[this._currentChannel].messages.push(msg);
        }
        return msg;
      },

      // Internal: add thread reply
      _addThreadReply: function (threadId, text) {
        if (!this._threads[threadId]) {
          // Initialize thread if doesn't exist
          const parentEl = document.querySelector(`[data-message-id="${threadId}"]`);
          const parentAuthor = parentEl
            ? parentEl.querySelector('.message-author').textContent
            : 'Unknown';
          const parentText = parentEl ? parentEl.querySelector('.message-text').textContent : '';
          this._threads[threadId] = {
            parentMessage: {
              id: threadId,
              author: parentAuthor,
              text: parentText,
            },
            replies: [],
          };
        }

        const reply = {
          id: 'reply-' + Date.now(),
          threadId: threadId,
          text: text,
          timestamp: new Date().toISOString(),
          channel: this._currentChannel,
          author: 'You',
        };

        this._threads[threadId].replies.push(reply);
        this._threadReplies.push(reply);
        return reply;
      },

      // Clear all messages (for testing)
      _reset: function () {
        this._outboundMessages = [];
        this._channelMessages = JSON.parse(JSON.stringify(channelData));
        this._threads = {};
        this._threadReplies = [];
        this._reactions = {};
        this._userReactions = [];
      },
    };

    // DOM Elements
    const messageInput = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-btn');
    const messagesContainer = document.getElementById('messages-container');
    const channelItems = document.querySelectorAll('.channel-item');
    const currentChannelName = document.getElementById('current-channel-name');
    const channelHeaderInfo = document.querySelector('.channel-header-info');
    const channelHeaderHash = document.querySelector('.channel-header .hash');
    const navItems = document.querySelectorAll('.nav-item');

    // Thread elements
    const threadPanel = document.getElementById('thread-panel');
    const threadCloseBtn = document.getElementById('thread-close-btn');
    const threadParent = document.getElementById('thread-parent');
    const threadReplies = document.getElementById('thread-replies');
    const threadRepliesLabel = document.getElementById('thread-replies-label');
    const threadInput = document.getElementById('thread-input');
    const threadSendBtn = document.getElementById('thread-send-btn');
    const threadChannelName = document.getElementById('thread-channel-name');

    let currentThreadId = null;

    // Render messages for a channel
    function renderChannel(channelId) {
      const channel = window.__slack_shell._channelMessages[channelId];
      if (!channel) return;

      messagesContainer.innerHTML = '';

      channel.messages.forEach((msg) => {
        const messageEl = createMessageElement(msg);
        messagesContainer.appendChild(messageEl);
      });

      // Update header
      if (channel.isDM) {
        channelHeaderHash.style.display = 'none';
        currentChannelName.textContent = channel.dmName;
        channelHeaderInfo.textContent = '';
      } else {
        channelHeaderHash.style.display = 'inline';
        currentChannelName.textContent = channelId;
        channelHeaderInfo.textContent = '| ' + channel.description;
      }

      // Update input placeholder
      messageInput.placeholder = `Message ${channel.isDM ? '' : '#'}${channel.isDM ? channel.dmName : channelId}`;

      // Scroll to bottom
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // Available emojis for the picker
    const availableEmojis = [
      'üëç',
      '‚ù§Ô∏è',
      'üòÇ',
      'üòÆ',
      'üò¢',
      'üéâ',
      'üî•',
      'üëÄ',
      '‚úÖ',
      'üöÄ',
      'üíØ',
      'üëè',
    ];

    // Create a message element
    function createMessageElement(msg) {
      const messageEl = document.createElement('div');
      messageEl.className = 'message';
      messageEl.dataset.messageId = msg.id;

      messageEl.innerHTML = `
                <div class="message-avatar" style="background:${msg.color}">${msg.initials}</div>
                <div class="message-content">
                    <div class="message-header">
                        <span class="message-author">${msg.author}</span>
                        <span class="message-time">${msg.time}</span>
                    </div>
                    <div class="message-text">${escapeHtml(msg.text)}</div>
                    <div class="message-reactions" data-message-id="${msg.id}"></div>
                    <button class="thread-indicator" data-message-id="${msg.id}" style="display:none">
                        <span class="thread-avatars"></span>
                        <span class="thread-count">0 replies</span>
                    </button>
                </div>
                <div class="message-actions">
                    <button class="message-action-btn react-btn" title="Add reaction" data-message-id="${msg.id}">üòÄ</button>
                    <button class="message-action-btn reply-btn" title="Reply in thread">üí¨</button>
                </div>
                <div class="emoji-picker" data-message-id="${msg.id}">
                    <div class="emoji-picker-grid">
                        ${availableEmojis.map((emoji) => `<button class="emoji-picker-btn" data-emoji="${emoji}">${emoji}</button>`).join('')}
                    </div>
                </div>
            `;

      // Add reply button listener
      messageEl.querySelector('.reply-btn').addEventListener('click', function () {
        openThread(msg.id);
      });

      // Add react button listener
      setupReactionListeners(messageEl, msg.id);

      // Check if this message has threads
      const thread = window.__slack_shell._threads[msg.id];
      if (thread && thread.replies.length > 0) {
        updateThreadIndicator(msg.id, thread.replies.length);
      }

      // Check if this message has reactions
      const reactions = window.__slack_shell._reactions[msg.id];
      if (reactions) {
        renderReactions(msg.id);
      }

      return messageEl;
    }

    // Setup reaction button listeners
    function setupReactionListeners(messageEl, messageId) {
      const reactBtn = messageEl.querySelector('.react-btn');
      const emojiPicker = messageEl.querySelector('.emoji-picker');

      reactBtn.addEventListener('click', function (e) {
        e.stopPropagation();
        // Close other open pickers
        document.querySelectorAll('.emoji-picker.open').forEach((p) => {
          if (p !== emojiPicker) p.classList.remove('open');
        });
        emojiPicker.classList.toggle('open');
      });

      // Emoji picker buttons
      emojiPicker.querySelectorAll('.emoji-picker-btn').forEach((btn) => {
        btn.addEventListener('click', function (e) {
          e.stopPropagation();
          const emoji = this.dataset.emoji;
          addReaction(messageId, emoji);
          emojiPicker.classList.remove('open');
        });
      });
    }

    // Add/toggle reaction on a message
    function addReaction(messageId, emoji) {
      window.__slack_shell._addReaction(messageId, emoji);
      renderReactions(messageId);
    }

    // Render reactions for a message
    function renderReactions(messageId) {
      const reactionsContainer = document.querySelector(
        `.message-reactions[data-message-id="${messageId}"]`
      );
      if (!reactionsContainer) return;

      const reactions = window.__slack_shell._reactions[messageId] || {};
      reactionsContainer.innerHTML = '';

      Object.entries(reactions).forEach(([emoji, data]) => {
        if (data.count > 0) {
          const badge = document.createElement('button');
          badge.className = 'reaction-badge' + (data.userReacted ? ' user-reacted' : '');
          badge.innerHTML = `
                        <span class="reaction-emoji">${emoji}</span>
                        <span class="reaction-count">${data.count}</span>
                    `;
          badge.addEventListener('click', function () {
            addReaction(messageId, emoji);
          });
          reactionsContainer.appendChild(badge);
        }
      });

      // Add "add reaction" button if there are existing reactions
      if (Object.keys(reactions).length > 0) {
        const addBtn = document.createElement('button');
        addBtn.className = 'add-reaction-btn';
        addBtn.innerHTML = '+';
        addBtn.title = 'Add reaction';
        addBtn.addEventListener('click', function (e) {
          e.stopPropagation();
          const messageEl = document.querySelector(`[data-message-id="${messageId}"]`);
          const emojiPicker = messageEl.querySelector('.emoji-picker');
          document.querySelectorAll('.emoji-picker.open').forEach((p) => {
            if (p !== emojiPicker) p.classList.remove('open');
          });
          emojiPicker.classList.toggle('open');
        });
        reactionsContainer.appendChild(addBtn);
      }
    }

    // Close emoji picker when clicking outside
    document.addEventListener('click', function () {
      document.querySelectorAll('.emoji-picker.open').forEach((p) => p.classList.remove('open'));
    });

    // Initialize with general channel
    renderChannel('general');

    // Navigation item click handlers
    const channelsSidebar = document.getElementById('channels-sidebar');
    navItems.forEach((item) => {
      item.addEventListener('click', function (e) {
        e.preventDefault();
        navItems.forEach((i) => i.classList.remove('active'));
        this.classList.add('active');
        window.__slack_shell._currentNav = this.dataset.nav;

        // Switch views
        document.querySelectorAll('.nav-view').forEach((v) => v.classList.remove('active'));
        const viewId = 'view-' + this.dataset.nav;
        const view = document.getElementById(viewId);
        if (view) {
          view.classList.add('active');
        }

        // Show/hide channels sidebar based on nav item (only show on Home)
        const showSidebar = this.dataset.nav === 'home';
        channelsSidebar.style.display = showSidebar ? 'flex' : 'none';
      });
    });

    // DM list item click handlers (in DMs view)
    document.querySelectorAll('.dm-list-item[data-dm-channel]').forEach((item) => {
      item.addEventListener('click', function () {
        const channel = this.dataset.dmChannel;
        if (channel) {
          // Switch to Home view
          navItems.forEach((i) => i.classList.remove('active'));
          document.querySelector('.nav-item[data-nav="home"]').classList.add('active');
          window.__slack_shell._currentNav = 'home';
          document.querySelectorAll('.nav-view').forEach((v) => v.classList.remove('active'));
          document.getElementById('view-home').classList.add('active');
          channelsSidebar.style.display = 'flex';

          // Switch to the DM channel
          channelItems.forEach((i) => i.classList.remove('active'));
          const dmItem = document.querySelector(`.channel-item[data-channel="${channel}"]`);
          if (dmItem) {
            dmItem.classList.add('active');
          }
          window.__slack_shell._currentChannel = channel;
          renderChannel(channel);
        }
      });
    });

    // Enable/disable send button based on input
    messageInput.addEventListener('input', function () {
      sendBtn.disabled = this.value.trim() === '';
      // Auto-resize textarea
      this.style.height = 'auto';
      this.style.height = Math.min(this.scrollHeight, 150) + 'px';
    });

    // Handle Enter key to send
    messageInput.addEventListener('keydown', function (e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        if (this.value.trim()) {
          sendMessage();
        }
      }
    });

    // Send button click
    sendBtn.addEventListener('click', sendMessage);

    // Send message function
    function sendMessage() {
      const text = messageInput.value.trim();
      if (!text) return;

      // Add to state
      const msg = window.__slack_shell._addOutboundMessage(text);

      // Create message element using the shared function
      const messageEl = createMessageElement(msg);

      messagesContainer.appendChild(messageEl);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;

      // Clear input
      messageInput.value = '';
      messageInput.style.height = 'auto';
      sendBtn.disabled = true;

      // Store in localStorage for persistence
      localStorage.setItem(
        'slack_messages',
        JSON.stringify(window.__slack_shell._outboundMessages)
      );
    }

    // Escape HTML to prevent XSS
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Open thread panel
    function openThread(messageId) {
      currentThreadId = messageId;
      window.__slack_shell._currentThreadId = messageId;

      const parentMsg = document.querySelector(`[data-message-id="${messageId}"]`);
      if (!parentMsg) return;

      const author = parentMsg.querySelector('.message-author').textContent;
      const text = parentMsg.querySelector('.message-text').textContent;
      const time = parentMsg.querySelector('.message-time').textContent;
      const avatarEl = parentMsg.querySelector('.message-avatar');
      const avatarStyle = avatarEl.getAttribute('style') || '';
      const avatarText = avatarEl.textContent;

      // Set parent message in thread panel
      threadParent.innerHTML = `
                <div class="message" style="padding:0;margin:0">
                    <div class="message-avatar" ${avatarStyle ? `style="${avatarStyle}"` : ''}>${avatarText}</div>
                    <div class="message-content">
                        <div class="message-header">
                            <span class="message-author">${author}</span>
                            <span class="message-time">${time}</span>
                        </div>
                        <div class="message-text">${escapeHtml(text)}</div>
                    </div>
                </div>
            `;

      // Load existing replies
      const thread = window.__slack_shell._threads[messageId];
      threadReplies.innerHTML = '';

      if (thread && thread.replies.length > 0) {
        threadRepliesLabel.textContent = `${thread.replies.length} ${thread.replies.length === 1 ? 'reply' : 'replies'}`;
        thread.replies.forEach((reply) => {
          appendThreadReply(reply);
        });
      } else {
        threadRepliesLabel.textContent = '0 replies';
      }

      threadChannelName.textContent = '#' + window.__slack_shell._currentChannel;
      threadPanel.classList.add('open');
      threadInput.focus();
    }

    // Close thread panel
    function closeThread() {
      threadPanel.classList.remove('open');
      currentThreadId = null;
      window.__slack_shell._currentThreadId = null;
    }

    threadCloseBtn.addEventListener('click', closeThread);

    // Thread input handling
    threadInput.addEventListener('input', function () {
      threadSendBtn.disabled = this.value.trim() === '';
      this.style.height = 'auto';
      this.style.height = Math.min(this.scrollHeight, 100) + 'px';
    });

    threadInput.addEventListener('keydown', function (e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        if (this.value.trim()) {
          sendThreadReply();
        }
      }
    });

    threadSendBtn.addEventListener('click', sendThreadReply);

    // Send thread reply
    function sendThreadReply() {
      const text = threadInput.value.trim();
      if (!text || !currentThreadId) return;

      // Add to state
      const reply = window.__slack_shell._addThreadReply(currentThreadId, text);

      // Append to thread panel
      appendThreadReply(reply);

      // Update reply count
      const thread = window.__slack_shell._threads[currentThreadId];
      const replyCount = thread.replies.length;
      threadRepliesLabel.textContent = `${replyCount} ${replyCount === 1 ? 'reply' : 'replies'}`;

      // Update thread indicator on parent message
      updateThreadIndicator(currentThreadId, replyCount);

      // Clear input
      threadInput.value = '';
      threadInput.style.height = 'auto';
      threadSendBtn.disabled = true;
    }

    // Append a reply to the thread panel
    function appendThreadReply(reply) {
      const replyEl = document.createElement('div');
      replyEl.className = 'message';
      replyEl.style.padding = '8px 0';

      const timeStr = new Date(reply.timestamp).toLocaleTimeString('en-US', {
        hour: 'numeric',
        minute: '2-digit',
        hour12: true,
      });

      const isUser = reply.author === 'You';
      const avatarBg = isUser ? '#2bac76' : '#4a154b';
      const avatarText = isUser
        ? 'Y'
        : reply.author
            .split(' ')
            .map((n) => n[0])
            .join('');

      replyEl.innerHTML = `
                <div class="message-avatar" style="background:${avatarBg}">${avatarText}</div>
                <div class="message-content">
                    <div class="message-header">
                        <span class="message-author">${reply.author}</span>
                        <span class="message-time">${timeStr}</span>
                    </div>
                    <div class="message-text">${escapeHtml(reply.text)}</div>
                </div>
            `;

      threadReplies.appendChild(replyEl);
      threadReplies.scrollTop = threadReplies.scrollHeight;
    }

    // Update thread indicator on main message
    function updateThreadIndicator(messageId, replyCount) {
      const parentMsg = document.querySelector(`[data-message-id="${messageId}"]`);
      if (!parentMsg) return;

      let indicator = parentMsg.querySelector('.thread-indicator');
      if (!indicator) {
        // Create indicator if doesn't exist
        const content = parentMsg.querySelector('.message-content');
        indicator = document.createElement('button');
        indicator.className = 'thread-indicator';
        indicator.dataset.messageId = messageId;
        indicator.innerHTML = `
                    <span class="thread-avatars">
                        <div class="thread-avatar" style="background:#2bac76">Y</div>
                    </span>
                    <span class="thread-count">${replyCount} ${replyCount === 1 ? 'reply' : 'replies'}</span>
                `;
        content.appendChild(indicator);
      } else {
        indicator.style.display = 'flex';
        indicator.querySelector('.thread-count').textContent =
          `${replyCount} ${replyCount === 1 ? 'reply' : 'replies'}`;

        // Add user avatar if not already there
        const avatars = indicator.querySelector('.thread-avatars');
        if (!avatars.querySelector('[style*="2bac76"]')) {
          const userAvatar = document.createElement('div');
          userAvatar.className = 'thread-avatar';
          userAvatar.style.background = '#2bac76';
          userAvatar.textContent = 'Y';
          avatars.appendChild(userAvatar);
        }
      }

      // Add click listener
      indicator.onclick = function () {
        openThread(messageId);
      };
    }

    // Add reply button listeners to initial messages
    document.querySelectorAll('.reply-btn').forEach((btn) => {
      btn.addEventListener('click', function () {
        const msg = this.closest('.message');
        openThread(msg.dataset.messageId);
      });
    });

    // Add thread indicator listeners
    document.querySelectorAll('.thread-indicator').forEach((indicator) => {
      indicator.addEventListener('click', function () {
        openThread(this.dataset.messageId);
      });
    });

    // Channel switching
    channelItems.forEach((item) => {
      item.addEventListener('click', function () {
        channelItems.forEach((i) => i.classList.remove('active'));
        this.classList.add('active');

        const channel = this.dataset.channel;
        window.__slack_shell._currentChannel = channel;

        // Switch to Home view if not already there
        navItems.forEach((i) => i.classList.remove('active'));
        document.querySelector('.nav-item[data-nav="home"]').classList.add('active');
        window.__slack_shell._currentNav = 'home';
        document.querySelectorAll('.nav-view').forEach((v) => v.classList.remove('active'));
        document.getElementById('view-home').classList.add('active');

        // Close thread panel on channel switch
        closeThread();

        // Render the new channel's messages
        renderChannel(channel);
      });
    });
  </script>
</div>
