name: "CI: Require Release Label"

on:
  pull_request:
    types: [opened, synchronize, labeled, unlabeled]

jobs:
  check-release-label:
    runs-on: ubuntu-latest
    steps:
      - name: Check for release label on publishable changes
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get changed files in this PR
          CHANGED_FILES=$(gh pr diff "${{ github.event.pull_request.number }}" \
            --repo "${{ github.repository }}" --name-only 2>/dev/null || true)

          if [ -z "$CHANGED_FILES" ]; then
            echo "No changed files detected, skipping."
            exit 0
          fi

          # Map paths to publishable services
          declare -A PATH_TO_SERVICE=(
            ["libs/python/cua-cli/"]="pypi/cli"
            ["libs/python/agent/"]="pypi/agent"
            ["libs/python/computer/"]="pypi/computer"
            ["libs/python/core/"]="pypi/core"
            ["libs/python/som/"]="pypi/som"
            ["libs/python/bench-ui/"]="pypi/bench-ui"
            ["libs/cua-bench/"]="pypi/bench"
            ["libs/python/computer-server/"]="pypi/computer-server"
            ["libs/python/mcp-server/"]="pypi/mcp-server"
            ["libs/typescript/cua-cli/"]="npm/cli"
            ["libs/typescript/computer/"]="npm/computer"
            ["libs/typescript/core/"]="npm/core"
            ["libs/typescript/playground/"]="npm/playground"
            ["libs/cuabot/"]="npm/cuabot"
            ["libs/xfce/"]="docker/xfce"
            ["libs/kasm/"]="docker/kasm"
            ["libs/lumier/"]="docker/lumier"
            ["libs/qemu-docker/android/"]="docker/qemu-android"
            ["libs/qemu-docker/linux/"]="docker/qemu-linux"
            ["libs/qemu-docker/windows/"]="docker/qemu-windows"
            ["libs/lume/"]="lume"
          )

          # Find affected services
          AFFECTED=()
          for path_prefix in "${!PATH_TO_SERVICE[@]}"; do
            if echo "$CHANGED_FILES" | grep -q "^${path_prefix}"; then
              service="${PATH_TO_SERVICE[$path_prefix]}"
              AFFECTED+=("$service")
            fi
          done

          # Deduplicate
          IFS=$'\n' AFFECTED=($(printf '%s\n' "${AFFECTED[@]}" | sort -u)); unset IFS

          if [ ${#AFFECTED[@]} -eq 0 ]; then
            echo "No publishable packages affected, skipping."
            exit 0
          fi

          echo "Affected packages:"
          for svc in "${AFFECTED[@]}"; do echo "  - $svc"; done

          # Get PR labels
          LABELS='${{ toJSON(github.event.pull_request.labels.*.name) }}'

          # If no-release is present, everything is covered
          if echo "$LABELS" | grep -q '"no-release"'; then
            echo "no-release label found, all packages covered."
            exit 0
          fi

          # Check which affected packages have a release:<service> label
          UNCOVERED=()
          for svc in "${AFFECTED[@]}"; do
            if echo "$LABELS" | grep -q "\"release:${svc}\""; then
              echo "Covered: $svc (has release:${svc} label)"
            else
              UNCOVERED+=("$svc")
            fi
          done

          if [ ${#UNCOVERED[@]} -eq 0 ]; then
            echo "All affected packages have release labels."
            exit 0
          fi

          echo ""
          echo "=========================================="
          echo "ERROR: Missing release labels!"
          echo "=========================================="
          echo ""
          echo "These packages are changed but have no release label:"
          for svc in "${UNCOVERED[@]}"; do echo "  - $svc"; done
          echo ""
          echo "Add a label for each package you want to release:"
          for svc in "${UNCOVERED[@]}"; do echo "  release:${svc}"; done
          echo ""
          echo "Or add 'no-release' to skip all releases."
          echo ""
          echo "Optionally add 'bump:minor' or 'bump:major' (default is patch)."
          echo ""
          exit 1
