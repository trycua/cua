name: "CD: Auto Release on Merge"

on:
  pull_request:
    types: [closed]

jobs:
  auto-release:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Detect packages and trigger release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          REPO="${{ github.repository }}"

          # Get labels
          LABELS='${{ toJSON(github.event.pull_request.labels.*.name) }}'

          # Skip if no-release
          if echo "$LABELS" | grep -q '"no-release"'; then
            echo "no-release label found, skipping."
            exit 0
          fi

          # Determine bump type from labels (default: patch)
          BUMP_TYPE="patch"
          if echo "$LABELS" | grep -q '"bump:major"'; then
            BUMP_TYPE="major"
          elif echo "$LABELS" | grep -q '"bump:minor"'; then
            BUMP_TYPE="minor"
          fi
          echo "Bump type: $BUMP_TYPE"

          # Collect release:<service> labels
          SERVICES=()
          ALL_SERVICES=(
            "pypi/cli" "pypi/agent" "pypi/computer" "pypi/core" "pypi/som"
            "pypi/bench" "pypi/bench-ui" "pypi/computer-server" "pypi/mcp-server"
            "npm/cli" "npm/computer" "npm/core" "npm/playground" "npm/cuabot"
            "docker/xfce" "docker/kasm" "docker/lumier"
            "docker/qemu-android" "docker/qemu-linux" "docker/qemu-windows"
            "lume"
          )

          for svc in "${ALL_SERVICES[@]}"; do
            if echo "$LABELS" | grep -q "\"release:${svc}\""; then
              SERVICES+=("$svc")
            fi
          done

          if [ ${#SERVICES[@]} -eq 0 ]; then
            echo "No release:<service> labels found, skipping."
            exit 0
          fi

          echo "Services to release:"
          for svc in "${SERVICES[@]}"; do echo "  - $svc"; done

          # Cascade dedup: remove services already covered by upstream cascades
          declare -A SVC_MAP
          for svc in "${SERVICES[@]}"; do SVC_MAP["$svc"]=1; done

          # pypi/core cascades to pypi/computer and pypi/agent
          if [[ -n "${SVC_MAP["pypi/core"]}" ]]; then
            unset SVC_MAP["pypi/computer"]
            unset SVC_MAP["pypi/agent"]
          fi
          # pypi/computer cascades to pypi/agent
          if [[ -n "${SVC_MAP["pypi/computer"]}" ]]; then
            unset SVC_MAP["pypi/agent"]
          fi
          # pypi/som cascades to pypi/agent
          if [[ -n "${SVC_MAP["pypi/som"]}" ]]; then
            unset SVC_MAP["pypi/agent"]
          fi
          # npm/core cascades to npm/computer
          if [[ -n "${SVC_MAP["npm/core"]}" ]]; then
            unset SVC_MAP["npm/computer"]
          fi

          echo ""
          echo "Services to release (after cascade dedup):"
          for svc in "${!SVC_MAP[@]}"; do echo "  - $svc"; done

          # Trigger release-bump-version for each service
          for svc in "${!SVC_MAP[@]}"; do
            echo ""
            echo "Triggering release-bump-version: service=$svc bump_type=$BUMP_TYPE"
            gh workflow run release-bump-version.yml \
              --repo "$REPO" \
              -f service="$svc" \
              -f bump_type="$BUMP_TYPE"
            echo "Triggered successfully."
            # Sleep between triggers to avoid race conditions on main branch
            sleep 15
          done

          echo ""
          echo "All releases triggered!"
