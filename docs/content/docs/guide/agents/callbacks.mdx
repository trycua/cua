---
title: Callbacks
description: Hooks into the agent lifecycle for logging, cost management, and data handling
---

import { Tabs, Tab } from 'fumadocs-ui/components/tabs';

Callbacks provide hooks into the agent's lifecycle, allowing for custom functionality at various stages of an agent's run. They enable extensibility for tasks such as logging, cost management, and data handling.

## Quick Start

```python
from cua import ComputerAgent
from cua.agent.callbacks import (
    ImageRetentionCallback,
    TrajectorySaverCallback,
    BudgetManagerCallback,
    LoggingCallback
)

agent = ComputerAgent(
    model="anthropic/claude-sonnet-4-5-20250929",
    tools=[computer],
    callbacks=[
        ImageRetentionCallback(only_n_most_recent_images=3),
        TrajectorySaverCallback(trajectory_dir="trajectories"),
        BudgetManagerCallback(max_budget=10.0, raise_error=True),
        LoggingCallback(level=logging.INFO)
    ]
)
```

## Built-in Callbacks

<Tabs items={['Cost Optimization', 'Trajectories', 'Logging']}>
<Tab value="Cost Optimization">

### Budget Manager

Control spending with budget limits:

```python
from cua.agent.callbacks import BudgetManagerCallback

agent = ComputerAgent(
    model="anthropic/claude-sonnet-4-5-20250929",
    tools=[computer],
    callbacks=[
        BudgetManagerCallback(
            max_budget=5.0,  # $5 limit
            reset_after_each_run=False,
            raise_error=True
        )
    ]
)
```

**Shorthand:**

```python
agent = ComputerAgent(
    model="anthropic/claude-sonnet-4-5-20250929",
    max_trajectory_budget=5.0  # $5 limit
)
```

**Options:**
- `max_budget`: Dollar limit for trajectory
- `reset_after_each_run`: Reset budget per run (default: True)
- `raise_error`: Raise exception vs. graceful stop (default: False)

### Image Retention

Reduce token usage by limiting images in context:

```python
from cua.agent.callbacks import ImageRetentionCallback

agent = ComputerAgent(
    model="anthropic/claude-sonnet-4-5-20250929",
    tools=[computer],
    callbacks=[
        ImageRetentionCallback(only_n_most_recent_images=3)
    ]
)
```

**Shorthand:**

```python
agent = ComputerAgent(
    model="anthropic/claude-sonnet-4-5-20250929",
    only_n_most_recent_images=3  # Auto-adds ImageRetentionCallback
)
```

### Combined Cost Optimization

```python
agent = ComputerAgent(
    model="anthropic/claude-sonnet-4-5-20250929",
    tools=[computer],
    max_trajectory_budget=5.0,        # Budget limit
    only_n_most_recent_images=3,      # Image retention
    trajectory_dir="trajectories"     # Track spending
)
```

</Tab>
<Tab value="Trajectories">

### TrajectorySaverCallback

Records complete agent conversations including messages, actions, and screenshots for debugging and analysis.

```python
from cua.agent.callbacks import TrajectorySaverCallback

agent = ComputerAgent(
    model="anthropic/claude-sonnet-4-5-20250929",
    tools=[computer],
    callbacks=[
        TrajectorySaverCallback(
            trajectory_dir="my_trajectories",
            save_screenshots=True
        )
    ]
)
```

**Shorthand:**

```python
agent = ComputerAgent(
    model="anthropic/claude-sonnet-4-5-20250929",
    trajectory_dir="trajectories",  # Auto-save trajectories
    tools=[computer]
)
```

### View Trajectories Online

View trajectories in the browser at **[cua.ai/trajectory-viewer](https://cua.ai/trajectory-viewer)**

The viewer provides:
- Interactive conversation replay
- Screenshot galleries
- No data collection

### Trajectory Structure

Each trajectory contains:
- **metadata.json**: Run info, timestamps, usage stats (`total_tokens`, `response_cost`)
- **turn_000/**: Turn-by-turn conversation history (api calls, responses, computer calls, screenshots)

</Tab>
<Tab value="Logging">

### LoggingCallback

Built-in logging for agent monitoring:

```python
from cua.agent.callbacks import LoggingCallback
import logging

agent = ComputerAgent(
    model="anthropic/claude-sonnet-4-5-20250929",
    tools=[computer],
    callbacks=[
        LoggingCallback(
            logger=logging.getLogger("cua"),
            level=logging.INFO
        )
    ]
)
```

**Shorthand:**

```python
agent = ComputerAgent(
    model="anthropic/claude-sonnet-4-5-20250929",
    tools=[computer],
    verbosity=logging.INFO  # Auto-adds LoggingCallback
)
```

### Custom Logger

Create custom loggers by extending AsyncCallbackHandler:

```python
from cua.agent.callbacks.base import AsyncCallbackHandler
import logging

class CustomLogger(AsyncCallbackHandler):
    def __init__(self, logger_name="agent"):
        self.logger = logging.getLogger(logger_name)
        self.logger.setLevel(logging.INFO)

        handler = logging.StreamHandler()
        formatter = logging.Formatter(
            '%(asctime)s - %(name)s - %(levelname)s - %(message)s'
        )
        handler.setFormatter(formatter)
        self.logger.addHandler(handler)

    async def on_run_start(self, kwargs, old_items):
        self.logger.info(f"Agent run started with model: {kwargs.get('model')}")

    async def on_computer_call_start(self, item):
        action = item.get('action', {})
        self.logger.info(f"Computer action: {action.get('type')}")

    async def on_usage(self, usage):
        cost = usage.get('response_cost', 0)
        self.logger.info(f"API call cost: ${cost:.4f}")

    async def on_run_end(self, kwargs, old_items, new_items):
        self.logger.info("Agent run completed")

# Use custom logger
agent = ComputerAgent(
    model="anthropic/claude-sonnet-4-5-20250929",
    tools=[computer],
    callbacks=[CustomLogger("my_agent")]
)
```

</Tab>
</Tabs>

## Callback Lifecycle

Callbacks are called in a specific order during agent execution:

| Order | Method | Description |
|-------|--------|-------------|
| 1 | `on_run_start(kwargs, old_items)` | Called once when agent run begins |
| 2 | `on_run_continue(kwargs, old_items, new_items)` | Called before each iteration. Return `False` to stop |
| 3 | `on_llm_start(messages)` | Preprocess messages before LLM call |
| 4 | `on_api_start(kwargs)` | Called before each LLM API call |
| 5 | `on_api_end(kwargs, result)` | Called after each LLM API call |
| 6 | `on_usage(usage)` | Called when usage info is received |
| 7 | `on_llm_end(messages)` | Postprocess messages after LLM call |
| 8 | `on_responses(kwargs, responses)` | Called when responses are received |
| 9 | Response hooks | `on_text`, `on_computer_call_start/end`, `on_function_call_start/end`, `on_screenshot` |
| 10 | `on_run_end(kwargs, old_items, new_items)` | Called when agent run completes |

## Custom Callbacks

Create custom callbacks by subclassing `AsyncCallbackHandler`:

```python
from cua.agent.callbacks.base import AsyncCallbackHandler

class CustomCallback(AsyncCallbackHandler):
    async def on_llm_start(self, messages):
        """Preprocess messages before LLM call"""
        # Add custom preprocessing logic
        return messages

    async def on_llm_end(self, messages):
        """Postprocess messages after LLM call"""
        # Add custom postprocessing logic
        return messages

    async def on_usage(self, usage):
        """Track usage information"""
        print(f"Tokens used: {usage.total_tokens}")
```
