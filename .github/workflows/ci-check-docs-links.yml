name: "CI: Check Docs Links"

on:
  pull_request:
    paths:
      - "docs/content/**"
      - "docs/src/**"
      - "docs/scripts/check-links.ts"
      - "docs/scripts/banned-terms.json"

jobs:
  check-internal-links:
    name: Check Internal Links (next-validate-link)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      - name: Install dependencies
        run: pnpm install
        working-directory: docs

      - name: Check internal links
        run: pnpm docs:check-links
        working-directory: docs

      - name: Show help if check failed
        if: failure()
        run: |
          echo ""
          echo "╔══════════════════════════════════════════════════════════════════╗"
          echo "║                    Broken Documentation Links!                    ║"
          echo "╠══════════════════════════════════════════════════════════════════╣"
          echo "║                                                                  ║"
          echo "║  One or more internal links in the documentation are broken.     ║"
          echo "║                                                                  ║"
          echo "║  To find broken links locally, run from the docs/ directory:     ║"
          echo "║                                                                  ║"
          echo "║    pnpm docs:check-links                                        ║"
          echo "║                                                                  ║"
          echo "╚══════════════════════════════════════════════════════════════════╝"

  check-terminology:
    name: Check Terminology
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for banned terms
        run: |
          ERRORS=0
          while IFS= read -r pattern; do
            replacement=$(jq -r --arg p "$pattern" '.terms[$p]' docs/scripts/banned-terms.json)
            if grep -rPn "$pattern" docs/content/ --include="*.mdx"; then
              echo ""
              echo "ERROR: Found banned term matching '$pattern' — use '$replacement' instead."
              echo ""
              ERRORS=$((ERRORS + 1))
            fi
          done < <(jq -r '.terms | keys[]' docs/scripts/banned-terms.json)

          if [ "$ERRORS" -gt 0 ]; then
            echo "Found $ERRORS banned term violation(s). See docs/scripts/banned-terms.json for the full list."
            exit 1
          fi
          echo "No banned terms found."

  check-external-links:
    name: Check External Links (lychee)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check external links
        uses: lycheeverse/lychee-action@v2
        with:
          args: >-
            --verbose
            --no-progress
            --accept 100..=399
            --exclude '^file://'
            --exclude 'localhost'
            --exclude '127\.0\.0\.1'
            --exclude 'example\.com'
            './docs/content/**/*.mdx'
          token: ${{ secrets.GITHUB_TOKEN }}
          fail: true
