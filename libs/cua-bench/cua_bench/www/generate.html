<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generate Environment - cua-bench</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/iconify-icon@3.0.2/dist/iconify-icon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css" />
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'vercel-bg': '#000000',
                        'vercel-card': '#0a0a0a',
                        'vercel-border': '#1a1a1a',
                        'vercel-text': '#ededed',
                        'vercel-muted': '#888888',
                        'vercel-accent': '#0070f3',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background: #000000;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
        }
        .link {
            color: #888888;
            transition: color 0.15s ease;
        }
        .link:hover {
            color: #ededed;
        }
        .input-field {
            background: #0a0a0a;
            border: 1px solid #1a1a1a;
            transition: all 0.2s ease;
        }
        .input-field:focus {
            border-color: #333333;
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.05);
            outline: none;
        }
        .btn-primary {
            background: #ffffff;
            color: #000000;
            border: 1px solid #333333;
            transition: all 0.15s ease;
        }
        .btn-primary:hover {
            background: #f5f5f5;
            transform: translateY(-1px);
        }
        .btn-primary:disabled {
            background: #333333;
            color: #666666;
            cursor: not-allowed;
            transform: none;
        }
        .placeholder-animation {
            transition: opacity 0.5s ease-in-out;
        }
        .quote-btn {
            background: transparent;
            color: #888888;
            border: 1px solid #1a1a1a;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.15s ease;
            cursor: pointer;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
        }
        .quote-btn:hover {
            color: #ededed;
            border-color: #333333;
            background: #0a0a0a;
        }
        /* Custom scrollbars */
        .custom-scrollbar::-webkit-scrollbar,
        .xterm-viewport::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track,
        .xterm-viewport::-webkit-scrollbar-track {
            background: #0a0a0a;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb,
        .xterm-viewport::-webkit-scrollbar-thumb {
            background: #333333;
            border-radius: 4px;
            transition: opacity 0.3s ease;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover,
        .xterm-viewport::-webkit-scrollbar-thumb:hover {
            background: #555555;
        }
        /* Auto-fade scrollbars */
        .xterm-viewport {
            scrollbar-width: thin;
            scrollbar-color: #333333 #0a0a0a;
        }
        .xterm-viewport::-webkit-scrollbar-thumb {
            opacity: 0.3;
        }
        .xterm-viewport:hover::-webkit-scrollbar-thumb {
            opacity: 1;
        }
        .copy-btn {
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        .command-container:hover .copy-btn {
            opacity: 1;
        }
    </style>
</head>
<body class="bg-vercel-bg text-vercel-text">
    <div class="min-h-screen">
        <!-- Navigation -->
        <nav class="border-b border-vercel-border">
            <div class="max-w-6xl mx-auto px-6 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <a href="dashboard.html" class="text-lg font-medium">cua-bench<span class="text-vercel-muted">==v0.1.0</span></a>
                    </div>
                    <div class="flex items-center gap-6">
                        <a href="/" class="link text-sm hover:text-vercel-text transition-colors pb-1">Home</a>
                        <a href="/environments" class="link text-sm hover:text-vercel-text transition-colors pb-1">My environments</a>
                        <a href="https://website-git-feat-rl-offering-cua-a38c7e3a.vercel.app/dashboard/benchmarks?dataset=cua-bench-miniwob" target="_blank" class="link text-sm hover:text-vercel-text transition-colors flex items-center gap-1 pb-1">
                            Environment registry
                            <iconify-icon icon="lucide:external-link" class="text-xs"></iconify-icon>
                        </a>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="max-w-4xl mx-auto px-6 py-16">
            <!-- Header -->
            <div class="text-center mb-8">
                <h1 class="text-5xl font-bold mb-3">Generate Environment</h1>
                <p class="text-vercel-muted text-xl max-w-4xl mx-auto leading-relaxed">
                    Describe your environment and we'll help you create an interactive task with AI assistance
                </p>
            </div>

            <!-- Input Section -->
            <div class="max-w-3xl mx-auto gap-4 flex flex-col">
                <div class="mb-8">
                    <label for="environment-description" class="block text-sm font-medium text-vercel-text mb-4">
                        <!-- Environment Description -->
                    </label>
                    <div class="relative">
                        <textarea
                            id="environment-description"
                            rows="2"
                            class="input-field w-full px-6 py-4 pb-16 text-lg rounded-lg resize-none text-vercel-text placeholder-vercel-muted"
                            placeholder="minesweeper game"
                        ></textarea>
                        <button
                            id="generate-btn"
                            class="btn-primary absolute bottom-6 right-6 px-6 py-2 rounded-md font-medium flex items-center gap-2 text-sm"
                            onclick="generateEnvironment()"
                        >
                            <iconify-icon icon="lucide:sparkles"></iconify-icon>
                            Generate Environment
                        </button>
                    </div>
                </div>

                <!-- Examples -->
                <div class="mt-12 text-center">
                    <p class="text-sm text-vercel-muted mb-6">Try these examples:</p>
                    <div class="flex flex-wrap justify-center gap-3 max-w-4xl mx-auto">
                        <button class="quote-btn" onclick="setExample('minesweeper game')">"minesweeper game"</button>
                        <button class="quote-btn" onclick="setExample('2048 game using app icons')">"2048 game using app icons"</button>
                        <button class="quote-btn" onclick="setExample('book a flight on airline website')">"book a flight on airline website"</button>
                        <button class="quote-btn" onclick="setExample('online shopping cart checkout')">"online shopping cart checkout"</button>
                        <button class="quote-btn" onclick="setExample('email client desktop app')">"email client desktop app"</button>
                        <button class="quote-btn" onclick="setExample('social media posting workflow')">"social media posting workflow"</button>
                        <button class="quote-btn" onclick="setExample('file manager with drag and drop')">"file manager with drag and drop"</button>
                        <button class="quote-btn" onclick="setExample('calendar scheduling app')">"calendar scheduling app"</button>
                        <button class="quote-btn" onclick="setExample('photo editing app')">"photo editing app"</button>
                        <button class="quote-btn" onclick="setExample('music player with playlist management')">"music player with playlists"</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Terminal Popup -->
    <div id="terminal-popup" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-vercel-card border border-vercel-border rounded-lg w-full max-w-4xl h-auto flex flex-col">
            <!-- Header -->
            <div class="flex items-center justify-between p-4 border-b border-vercel-border">
                <h3 class="font-medium">Generating Environment</h3>
                <button id="action-btn" class="px-3 py-1 text-sm bg-red-600 hover:bg-red-700 text-white rounded transition-colors">
                    Cancel
                </button>
            </div>
            
            <!-- Command Display -->
            <div class="p-2 border-b border-vercel-border">
                <div class="command-container relative border border-vercel-border rounded-md p-3 bg-black">
                    <pre id="command-display" class="text-sm text-vercel-text font-mono overflow-x-auto custom-scrollbar pr-8 pb-2"></pre>
                    <button id="copy-command-btn" class="copy-btn absolute -top-[1px] -right-[1px] p-2 flex bg-vercel-card border border-vercel-border hover:bg-vercel-border rounded-md transition-colors">
                        <iconify-icon icon="lucide:copy" class="text-sm"></iconify-icon>
                    </button>
                </div>
            </div>
            
            <!-- Terminal -->
            <div class="flex-1 p-4">
                <div id="terminal" class="w-full h-auto"></div>
            </div>
        </div>
    </div>

    <script>
        const placeholders = [
            "minesweeper game",
            "2048 game using app icons", 
            "book a flight on airline website",
            "online shopping cart checkout",
            "email client desktop app",
            "social media posting workflow",
            "file manager with drag and drop",
            "calendar scheduling app",
            "photo editing app",
            "music player with playlist management"
        ];

        let currentPlaceholderIndex = 0;
        let terminal = null;
        let currentJobId = null;
        let pollInterval = null;
        const textarea = document.getElementById('environment-description');
        const popup = document.getElementById('terminal-popup');
        const commandDisplay = document.getElementById('command-display');
        const actionBtn = document.getElementById('action-btn');
        const copyCommandBtn = document.getElementById('copy-command-btn');

        function cyclePlaceholder() {
            if (textarea.value === '' && document.activeElement !== textarea) {
                textarea.placeholder = placeholders[currentPlaceholderIndex];
                currentPlaceholderIndex = (currentPlaceholderIndex + 1) % placeholders.length;
            }
        }

        // Cycle placeholder text every 3 seconds
        setInterval(cyclePlaceholder, 3000);

        function setExample(text) {
            textarea.value = text;
            textarea.focus();
        }

        function showPopup() {
            popup.classList.remove('hidden');
            
            // Initialize terminal if not already done
            if (!terminal) {
                terminal = new Terminal({
                    theme: {
                        background: '#0a0a0a',
                        foreground: '#ededed',
                        cursor: '#ededed',
                        selection: '#333333'
                    },
                    fontSize: 14,
                    fontFamily: 'SF Mono, Monaco, Inconsolata, Roboto Mono, monospace'
                });
                // allow ctrl + c for copy when selecting data, default otherwise
                terminal.attachCustomKeyEventHandler((arg) => { 
                    if (arg.ctrlKey && arg.code === "KeyC" && arg.type === "keydown") {
                        const selection = terminal.getSelection();
                        if (selection) {
                            copyText(selection);
                            return false;
                        }
                    }
                    return true;
                }); 
                terminal.open(document.getElementById('terminal'));
            }
        }

        function hidePopup() {
            popup.classList.add('hidden');
            if (currentJobId && pollInterval) {
                clearInterval(pollInterval);
                pollInterval = null;
                currentJobId = null;
            }
        }

        async function cancelJob() {
            if (currentJobId) {
                try {
                    await fetch(`/api/job/${currentJobId}/cancel`, {
                        method: 'POST'
                    });
                    terminal.writeln('\r\n\x1b[31mProcess cancelled by user\x1b[0m');
                } catch (error) {
                    terminal.writeln(`\r\n\x1b[31mError cancelling: ${error.message}\x1b[0m`);
                }
                
                if (pollInterval) {
                    clearInterval(pollInterval);
                    pollInterval = null;
                }
                
                currentJobId = null;
                actionBtn.textContent = 'Close';
                actionBtn.className = 'px-3 py-1 text-sm bg-vercel-border hover:bg-vercel-muted text-white rounded transition-colors';
            } else {
                hidePopup();
            }
        }

        async function pollJobOutput(jobId) {
            try {
                const response = await fetch(`/api/job/${jobId}/output`);
                const data = await response.json();
                
                if (data.error) {
                    terminal.writeln(`\x1b[31mError: ${data.error}\x1b[0m`);
                    return;
                }
                
                // Write new output lines
                data.lines.forEach(line => {
                    if (line.type === 'output') {
                        terminal.writeln(line.content);
                    } else if (line.type === 'error') {
                        terminal.writeln(`\x1b[31mError: ${line.content}\x1b[0m`);
                    } else if (line.type === 'exit') {
                        if (line.content === 0) {
                            terminal.writeln('\x1b[32mProcess completed successfully!\x1b[0m');
                        } else {
                            terminal.writeln(`\x1b[31mProcess exited with code: ${line.content}\x1b[0m`);
                        }
                    }
                });
                
                // Check if job is still running
                if (!data.running) {
                    if (pollInterval) {
                        clearInterval(pollInterval);
                        pollInterval = null;
                    }
                    currentJobId = null;
                    actionBtn.textContent = 'Close';
                    actionBtn.className = 'px-3 py-1 text-sm bg-vercel-border hover:bg-vercel-muted text-white rounded transition-colors';
                }
                
            } catch (error) {
                terminal.writeln(`\x1b[31mPolling error: ${error.message}\x1b[0m`);
            }
        }

        async function generateEnvironment() {
            const description = textarea.value.trim();
            if (!description) {
                alert('Please enter an environment description');
                return;
            }

            try {
                // Show popup and prepare terminal
                showPopup();
                terminal.clear();
                
                // Start job
                const response = await fetch('/api/generate-environment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ description })
                });

                const data = await response.json();
                
                if (data.error) {
                    terminal.writeln(`\x1b[31mError: ${data.error}\x1b[0m`);
                    return;
                }

                // Display command
                commandDisplay.textContent = data.command;
                
                // Set up job tracking
                currentJobId = data.job_id;
                actionBtn.textContent = 'Cancel';
                actionBtn.className = 'px-3 py-1 text-sm bg-red-600 hover:bg-red-700 text-white rounded transition-colors';
                
                // Start polling for output
                pollInterval = setInterval(() => pollJobOutput(currentJobId), 500);
                
            } catch (error) {
                if (terminal) {
                    terminal.writeln(`\x1b[31mError: ${error.message}\x1b[0m`);
                } else {
                    alert(`Error: ${error.message}`);
                }
            }
        }

        // Copy command functionality
        async function copyCommand() {
            const command = commandDisplay.textContent;
            if (command) {
                try {
                    await navigator.clipboard.writeText(command);
                    // Show brief feedback
                    const originalIcon = copyCommandBtn.innerHTML;
                    copyCommandBtn.innerHTML = '<iconify-icon icon="lucide:check" class="text-sm text-green-500"></iconify-icon>';
                    setTimeout(() => {
                        copyCommandBtn.innerHTML = originalIcon;
                    }, 1000);
                } catch (error) {
                    console.error('Failed to copy command:', error);
                }
            }
        }

        // Event listeners
        actionBtn.addEventListener('click', cancelJob);
        copyCommandBtn.addEventListener('click', copyCommand);

        // Close popup when clicking outside
        popup.addEventListener('click', function(e) {
            if (e.target === popup) {
                hidePopup();
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'Enter') {
                generateEnvironment();
            }
            if (e.key === 'Escape' && !popup.classList.contains('hidden')) {
                hidePopup();
            }
        });

        // Focus textarea on load
        window.addEventListener('load', function() {
            textarea.focus();
        });
    </script>
</body>
</html>
