<!doctype html>
<html lang="en" class="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Environments - CUA-Bench</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/iconify-icon@3.0.2/dist/iconify-icon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css" />
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            colors: {
              'vercel-bg': '#000000',
              'vercel-card': '#0a0a0a',
              'vercel-border': '#1a1a1a',
              'vercel-text': '#ededed',
              'vercel-muted': '#888888',
              'vercel-accent': '#0070f3',
            },
          },
        },
      };
    </script>
    <style>
      body {
        background: #000000;
        font-family:
          -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell',
          'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
      }
      .card {
        background: linear-gradient(145deg, #0a0a0a 0%, #111111 100%);
        border: 1px solid #1a1a1a;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      }
      .card:hover {
        border-color: #333333;
        transform: translateY(-1px);
        box-shadow:
          0 10px 25px -5px rgba(0, 0, 0, 0.5),
          0 8px 10px -6px rgba(0, 0, 0, 0.3);
      }
      .generating-card {
        border-color: #0070f3;
        background: linear-gradient(145deg, #0a0a0a 0%, #001a3d 100%);
      }
      .generating-card:hover {
        border-color: #0070f3;
        box-shadow:
          0 10px 25px -5px rgba(0, 112, 243, 0.3),
          0 8px 10px -6px rgba(0, 112, 243, 0.2);
      }
      .link {
        color: #888888;
        text-decoration: none;
      }
      .link:hover {
        color: #ededed;
      }
      .spinner {
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }

      /* Terminal popup styles */
      .terminal-popup {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        z-index: 1000;
        display: none;
      }

      .terminal-content {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 90%;
        max-width: 1000px;
        height: 80%;
        background: #0a0a0a;
        border: 1px solid #1a1a1a;
        border-radius: 8px;
        display: flex;
        flex-direction: column;
      }

      .terminal-header {
        padding: 16px;
        border-bottom: 1px solid #1a1a1a;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .terminal-body {
        flex: 1;
        padding: 16px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      .xterm-container {
        flex: 1;
        border: 1px solid #1a1a1a;
        border-radius: 4px;
        padding: 8px;
        background: #000;
        overflow: hidden;
      }
    </style>
  </head>
  <body class="bg-vercel-bg text-vercel-text">
    <div class="min-h-screen">
      <!-- Navigation -->
      <nav class="border-b border-vercel-border">
        <div class="max-w-6xl mx-auto px-6 py-4">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
              <a href="/" class="text-lg font-medium"
                >cua-bench<span class="text-vercel-muted">==v0.1.0</span></a
              >
            </div>
            <div class="flex items-center gap-6">
              <a href="/" class="link text-sm hover:text-vercel-text transition-colors pb-1"
                >Home</a
              >
              <a
                href="/environments"
                class="text-sm text-vercel-text transition-colors border-b border-vercel-text pb-1"
                >My environments</a
              >
              <a
                href="https://cua.ai/registry"
                target="_blank"
                class="link text-sm hover:text-vercel-text transition-colors flex items-center gap-1 pb-1"
              >
                Environment registry
                <iconify-icon icon="lucide:external-link" class="text-xs"></iconify-icon>
              </a>
            </div>
          </div>
        </div>
      </nav>

      <!-- Main Content -->
      <main class="max-w-6xl mx-auto px-6 py-12">
        <!-- Header -->
        <div class="mb-12">
          <h1 class="text-4xl font-bold text-vercel-text mb-4">My Environments</h1>
          <p class="text-vercel-muted text-lg">
            Manage your generated environments and track generation progress
          </p>
        </div>

        <!-- Environments Grid -->
        <div id="environments-grid" class="grid grid-cols-1 gap-4 md:grid-cols-2 xl:grid-cols-3">
          <!-- Loading state -->
          <div id="loading-state" class="col-span-full flex items-center justify-center py-12">
            <div class="flex items-center space-x-3 text-vercel-muted">
              <iconify-icon icon="line-md:loading-twotone-loop" class="text-2xl"></iconify-icon>
              <span>Loading environments...</span>
            </div>
          </div>
        </div>

        <!-- Empty state -->
        <div id="empty-state" class="hidden col-span-full text-center py-12 opacity-50">
          <iconify-icon
            icon="lucide:folder-open"
            class="text-6xl text-vercel-muted mb-4"
          ></iconify-icon>
          <h3 class="text-xl font-semibold text-vercel-text mb-2">No environments yet</h3>
          <p class="text-vercel-muted mb-6">Create your first environment to get started</p>
          <a
            href="/generate"
            class="inline-flex items-center px-4 py-2 bg-white text-black rounded-lg hover:bg-gray-100 transition-colors font-medium"
          >
            <iconify-icon icon="lucide:plus" class="mr-2"></iconify-icon>
            Generate Environment
          </a>
        </div>
      </main>
    </div>

    <!-- Terminal Popup -->
    <div id="terminal-popup" class="terminal-popup">
      <div class="terminal-content">
        <div class="terminal-header">
          <div class="flex-1">
            <h3 class="text-lg font-semibold text-vercel-text" id="terminal-title">
              Environment Generation
            </h3>
            <p class="text-sm text-vercel-muted" id="terminal-subtitle">
              Generating environment...
            </p>
          </div>
          <button
            id="terminal-close"
            class="text-vercel-muted hover:text-vercel-text transition-colors"
          >
            <iconify-icon icon="lucide:x" class="text-xl"></iconify-icon>
          </button>
        </div>
        <div class="terminal-body">
          <div class="xterm-container" id="xterm-container">
            <!-- Terminal will be mounted here -->
          </div>
        </div>
      </div>
    </div>

    <script>
      let environments = [];
      let currentJobId = null;
      let terminal = null;
      let pollInterval = null;

      // Load environments on page load
      document.addEventListener('DOMContentLoaded', function () {
        loadEnvironments();
        // Refresh every 2 seconds
        setInterval(loadEnvironments, 2000);
      });

      async function loadEnvironments() {
        try {
          const response = await fetch('/api/environments');
          const data = await response.json();
          environments = data.environments || [];
          renderEnvironments();
        } catch (error) {
          console.error('Failed to load environments:', error);
        }
      }

      function renderEnvironments() {
        const grid = document.getElementById('environments-grid');
        const loadingState = document.getElementById('loading-state');
        const emptyState = document.getElementById('empty-state');

        // Hide loading state
        loadingState.style.display = 'none';

        if (environments.length === 0) {
          emptyState.classList.remove('hidden');
          return;
        }

        emptyState.classList.add('hidden');

        // Clear existing cards
        const existingCards = grid.querySelectorAll('button');
        existingCards.forEach((card) => card.remove());

        // Render environment cards
        environments.forEach((env) => {
          const card = createEnvironmentCard(env);
          grid.appendChild(card);
        });
      }

      function createEnvironmentCard(env) {
        const card = document.createElement('button');
        card.type = 'button';
        card.className =
          'flex flex-col items-start gap-3 rounded-xl border border-vercel-border bg-vercel-card p-4 text-left transition-colors hover:border-neutral-300 hover:shadow-sm';

        // Create tags from metadata
        const tags = [];
        if (env.metadata?.category) tags.push(env.metadata.category);
        if (env.metadata?.difficulty) tags.push(env.metadata.difficulty);
        if (env.metadata?.tags) tags.push(...env.metadata.tags);

        const tagsHtml =
          tags.length > 0
            ? tags
                .map(
                  (tag) =>
                    `<span class="rounded-full bg-neutral-100 px-2 py-0.5 text-neutral-700 text-xs dark:bg-neutral-800 dark:text-neutral-300">${tag}</span>`
                )
                .join('')
            : '';

        const statusIndicator =
          env.status === 'generating'
            ? '<iconify-icon icon="line-md:loading-twotone-loop" class="text-vercel-accent spinner h-4 w-4"></iconify-icon>'
            : '';

        card.innerHTML = `
                <div class="flex w-full items-center justify-between">
                    <div>
                        <div class="flex items-center gap-2">
                            <h3 class="truncate font-semibold text-vercel-text">${env.name}</h3>
                            ${statusIndicator}
                        </div>
                        ${
                          tagsHtml
                            ? `
                            <div class="mt-1 flex flex-wrap gap-2">
                                ${tagsHtml}
                            </div>
                        `
                            : ''
                        }
                    </div>
                    <iconify-icon icon="lucide:chevron-right" class="h-4 w-4 text-neutral-400"></iconify-icon>
                </div>
                
                ${
                  env.description
                    ? `
                    <p class="line-clamp-3 text-neutral-600 text-sm dark:text-neutral-400">${env.description}</p>
                `
                    : ''
                }
                
                <div class="mt-2 flex flex-wrap items-center gap-3 text-neutral-500 text-xs dark:text-neutral-400">
                    ${env.status === 'generating' ? '<span>Generating...</span>' : '<span>Ready</span>'}
                </div>
                
                <div class="text-[11px] text-neutral-500 dark:text-neutral-400">
                    ${env.created_at ? `Created ${new Date(env.created_at).toLocaleDateString()}` : 'Environment'}
                </div>
            `;

        // Add click handler
        card.addEventListener('click', () => {
          if (env.status === 'generating' && env.job_id) {
            showTerminalOutput(env);
          } else {
            // Navigate to environment detail page
            window.location.href = `/environments/${env.name}`;
          }
        });

        return card;
      }

      function showTerminalOutput(env) {
        currentJobId = env.job_id;

        // Update popup title
        document.getElementById('terminal-title').textContent = env.name;
        document.getElementById('terminal-subtitle').textContent =
          env.description || 'Generating environment...';

        // Show popup
        document.getElementById('terminal-popup').style.display = 'block';

        // Initialize terminal
        if (terminal) {
          terminal.dispose();
        }

        terminal = new Terminal({
          theme: {
            background: '#000000',
            foreground: '#ffffff',
            cursor: '#ffffff',
          },
          fontSize: 14,
          fontFamily: 'Consolas, "Courier New", monospace',
        });

        const container = document.getElementById('xterm-container');
        container.innerHTML = '';
        terminal.open(container);

        // Load history first, then start polling
        loadTerminalHistory();
      }

      async function loadTerminalHistory() {
        if (!currentJobId) return;

        try {
          const response = await fetch(`/api/job/${currentJobId}/history`);
          const data = await response.json();

          if (data.lines) {
            data.lines.forEach((line) => {
              if (line.type === 'output') {
                terminal.writeln(line.content);
              } else if (line.type === 'error') {
                terminal.writeln(`\x1b[31m${line.content}\x1b[0m`);
              } else if (line.type === 'exit') {
                terminal.writeln(
                  `\x1b[32mProcess completed with exit code: ${line.content}\x1b[0m`
                );
              }
            });
          }

          // Start polling for new output after loading history
          startPolling();
        } catch (error) {
          console.error('Failed to load terminal history:', error);
          // Start polling anyway
          startPolling();
        }
      }

      function startPolling() {
        if (pollInterval) {
          clearInterval(pollInterval);
        }

        pollInterval = setInterval(async () => {
          if (!currentJobId) return;

          try {
            const response = await fetch(`/api/job/${currentJobId}/output`);
            const data = await response.json();

            if (data.lines) {
              data.lines.forEach((line) => {
                if (line.type === 'output') {
                  terminal.writeln(line.content);
                } else if (line.type === 'error') {
                  terminal.writeln(`\x1b[31m${line.content}\x1b[0m`);
                } else if (line.type === 'exit') {
                  terminal.writeln(
                    `\x1b[32mProcess completed with exit code: ${line.content}\x1b[0m`
                  );
                  stopPolling();
                }
              });
            }

            if (!data.running) {
              stopPolling();
            }
          } catch (error) {
            console.error('Failed to poll output:', error);
            stopPolling();
          }
        }, 500);
      }

      function stopPolling() {
        if (pollInterval) {
          clearInterval(pollInterval);
          pollInterval = null;
        }
      }

      function closeTerminal() {
        document.getElementById('terminal-popup').style.display = 'none';
        stopPolling();
        currentJobId = null;
        if (terminal) {
          terminal.dispose();
          terminal = null;
        }
      }

      // Event listeners
      document.getElementById('terminal-close').addEventListener('click', closeTerminal);

      // Close on escape key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          closeTerminal();
        }
      });

      // Close on backdrop click
      document.getElementById('terminal-popup').addEventListener('click', (e) => {
        if (e.target === document.getElementById('terminal-popup')) {
          closeTerminal();
        }
      });
    </script>
  </body>
</html>
